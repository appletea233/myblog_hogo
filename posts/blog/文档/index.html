<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=robots content="index, follow"><title>BUAAæ“ä½œç³»ç»Ÿlab3ç¬”è®° | Appletea's Blog</title><meta name=keywords content="study,os"><meta name=description content="å¦‚é¢˜"><meta name=author content="
ä½œè€…:&nbsp;Appletea"><link rel=canonical href=http://appletea233.github.io/myblog_hogo/posts/blog/%E6%96%87%E6%A1%A3/><link crossorigin=anonymous href=/myblog_hogo/assets/css/stylesheet.min.dafbad219c160a2cdb650c1eb791a4a2416f32636655e6cfe0792b9e36128edc.css integrity="sha256-2vutIZwWCizbZQwet5GkokFvMmNmVebP4HkrnjYSjtw=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/myblog_hogo/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=http://appletea233.github.io/myblog_hogo/img/Q.jpg><link rel=icon type=image/png sizes=16x16 href=http://appletea233.github.io/myblog_hogo/img/Q.jpg><link rel=icon type=image/png sizes=32x32 href=http://appletea233.github.io/myblog_hogo/img/Q.jpg><link rel=apple-touch-icon href=http://appletea233.github.io/myblog_hogo/Q.jpg><link rel=mask-icon href=http://appletea233.github.io/myblog_hogo/Q.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="BUAAæ“ä½œç³»ç»Ÿlab3ç¬”è®°"><meta property="og:description" content="å¦‚é¢˜"><meta property="og:type" content="article"><meta property="og:url" content="http://appletea233.github.io/myblog_hogo/posts/blog/%E6%96%87%E6%A1%A3/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-08T17:43:03+08:00"><meta property="article:modified_time" content="2022-05-08T17:43:03+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="BUAAæ“ä½œç³»ç»Ÿlab3ç¬”è®°"><meta name=twitter:description content="å¦‚é¢˜"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"ğŸ“šæ–‡ç« ","item":"http://appletea233.github.io/myblog_hogo/posts/"},{"@type":"ListItem","position":3,"name":"Blog","item":"http://appletea233.github.io/myblog_hogo/posts/blog/"},{"@type":"ListItem","position":4,"name":"BUAAæ“ä½œç³»ç»Ÿlab3ç¬”è®°","item":"http://appletea233.github.io/myblog_hogo/posts/blog/%E6%96%87%E6%A1%A3/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"BUAAæ“ä½œç³»ç»Ÿlab3ç¬”è®°","name":"BUAAæ“ä½œç³»ç»Ÿlab3ç¬”è®°","description":"å¦‚é¢˜","keywords":["study","os"],"articleBody":"å‡½æ•°è°ƒç”¨å…³ç³» ç»“æ„ä½“ä¿¡æ¯ Page 1 2 3 4 5 6 7 8 9  struct Page_list{ struct { struct { struct Page *le_next; struct Page le_prev; } pp_link; u_short pp_ref; }* lh_first; // Page* }    Env_listç»“æ„ä¸ä¹‹ç±»ä¼¼  Trapframe 1 2 3 4 5 6 7 8 9 10 11 12 13  struct Trapframe { //lr:need to be modified(reference to linux pt_regs) TODO \t/* Saved main processor registers. */ unsigned long regs[32]; /* Saved special registers. */ unsigned long cp0_status; unsigned long hi; unsigned long lo; unsigned long cp0_badvaddr; unsigned long cp0_cause; unsigned long cp0_epc; unsigned long pc; };   Env 1 2 3 4 5 6 7 8 9 10 11  struct Env { struct Trapframe env_tf; // Saved registers  LIST_ENTRY(Env) env_link; // Free LIST_ENTRY  u_int env_id; // Unique environment identifier  u_int env_parent_id; // env_id of this env's parent  u_int env_status; // Status of the environment  Pde *env_pgdir; // Kernel virtual address of page dir  u_int env_cr3; LIST_ENTRY(Env) env_sched_link; u_int env_pri; };    env_status : è¯¥å˜é‡åªèƒ½æœ‰ä»¥ä¸‹ä¸‰ç§å–å€¼ï¼š   ENV_FREE : è¡¨æ˜è¯¥è¿›ç¨‹æ˜¯ä¸æ´»åŠ¨çš„ï¼Œå³è¯¥è¿›ç¨‹æ§åˆ¶å—å¤„äºè¿›ç¨‹ç©ºé—²é“¾è¡¨ä¸­ã€‚ ENV_NOT_RUNNABLE : è¡¨æ˜è¯¥è¿›ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œå¤„äºè¯¥çŠ¶æ€çš„è¿›ç¨‹éœ€è¦åœ¨ä¸€å®šæ¡ä»¶ä¸‹å˜æˆå°±ç»ªçŠ¶æ€ä»è€Œè¢«CPUè°ƒåº¦ã€‚ï¼ˆæ¯”å¦‚å› è¿›ç¨‹é€šä¿¡é˜»å¡æ—¶å˜ä¸º ENV_NOT_RUNNABLEï¼Œæ”¶åˆ°ä¿¡æ¯åå˜å› ENV_RUNNABLEï¼‰ ENV_RUNNABLE : è¡¨æ˜è¯¥è¿›ç¨‹å¤„äºæ‰§è¡ŒçŠ¶æ€æˆ–å°±ç»ªçŠ¶æ€ï¼Œå³å…¶å¯èƒ½æ˜¯æ­£åœ¨è¿è¡Œçš„ï¼Œä¹Ÿå¯èƒ½æ­£åœ¨ç­‰å¾…è¢«è°ƒåº¦ã€‚  Ehdrä¸Phdr 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  typedef struct { unsigned char\te_ident[EI_NIDENT];\t/* Magic number and other info */ Elf32_Half\te_type;\t/* Object file type */ Elf32_Half\te_machine;\t/* Architecture */ Elf32_Word\te_version;\t/* Object file version */ Elf32_Addr\te_entry;\t/* Entry point virtual address */ Elf32_Off\te_phoff;\t/* Program header table file offset */ Elf32_Off\te_shoff;\t/* Section header table file offset */ Elf32_Word\te_flags;\t/* Processor-specific flags */ Elf32_Half\te_ehsize;\t/* ELF header size in bytes */ Elf32_Half\te_phentsize;\t/* Program header table entry size */ Elf32_Half\te_phnum;\t/* Program header table entry count */ Elf32_Half\te_shentsize;\t/* Section header table entry size */ Elf32_Half\te_shnum;\t/* Section header table entry count */ Elf32_Half\te_shstrndx;\t/* Section header string table index */ } Elf32_Ehdr;   1 2 3 4 5 6 7 8 9 10  typedef struct { Elf32_Word\tp_type;\t/* Segment type */ Elf32_Off\tp_offset;\t/* Segment file offset */ Elf32_Addr\tp_vaddr;\t/* Segment virtual address */ Elf32_Addr\tp_paddr;\t/* Segment physical address */ Elf32_Word\tp_filesz;\t/* Segment size in file */ Elf32_Word\tp_memsz;\t/* Segment size in memory */ Elf32_Word\tp_flags;\t/* Segment flags */ Elf32_Word\tp_align;\t/* Segment alignment */ } Elf32_Phdr;   ä¸€äº›å…¨å±€å˜é‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54  // env.h ./include/env.h:11:#define LOG2NENV 10 ./include/env.h:12:#define NENV (1LOG2NENV) ./include/env.h:13:#define ENVX(envid) ((envid) \u0026 (NENV - 1)) // env.c struct Env *envs = NULL; // All environments struct Env *curenv = NULL; // the current env  static struct Env_list env_free_list; // Free list struct Env_list env_sched_list[2]; // Runnable list  extern Pde *boot_pgdir; extern char *KERNEL_SP; static u_int asid_bitmap[2] = {0}; // 64  // mmu.c ./include/error.h:8:#define E_BAD_ENV 2 // Environment doesn't exist or otherwise ./include/mmu.h:109:#define E_BAD_ENV 2 // Environment doesn't exist or otherwise  // pageç›¸å…³ #define BY2PG\t4096\t// bytes to a page #define PDMAP\t(4*1024*1024)\t// bytes mapped by a page directory entry #define PGSHIFT\t12 #define PDSHIFT\t22\t// log2(PDMAP) #define PDX(va)\t((((u_long)(va))22) \u0026 0x03FF) // å–é¡µç›®å½•åºå· #define PTX(va)\t((((u_long)(va))12) \u0026 0x03FF) // å–...åºå· #define PTE_ADDR(pte)\t((u_long)(pte)\u0026~0xFFF)  // page number field of address #define PPN(va)\t(((u_long)(va))12) #define VPN(va)\tPPN(va)  #define VA2PFN(va)\t(((u_long)(va)) \u0026 0xFFFFF000 ) // va 2 PFN for EntryLo0/1 #define PTE2PT\t1024  // å†…å­˜åœ°å›¾ #define KERNBASE 0x80010000  #define VPT (ULIM + PDMAP ) #define KSTACKTOP (VPT-0x100) #define KSTKSIZE (8*BY2PG) #define ULIM 0x80000000\t #define UVPT (ULIM - PDMAP) #define UPAGES (UVPT - PDMAP) #define UENVS (UPAGES - PDMAP) #define UTOP UENVS  #define UXSTACKTOP (UTOP) #define TIMESTACK 0x82000000  #define PTE_ADDR(pte) ((u_long)(pte)\u0026~0xFFF)   0x00400000\nå˜é‡è½¬æ¢  page2ppn page2pa page2kvaï¼šå°†é¡µè½¬æ¢ä¸ºå†…æ ¸çš„è™šæ‹Ÿåœ°å€ va2pa  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55  LIST_HEAD(Page_list, Page); typedef LIST_ENTRY(Page) Page_LIST_entry_t; struct Page { Page_LIST_entry_t pp_link;\t/* free list link */ // Ref is the count of pointers (usually in page table entries) \t// to this page. This only holds for pages allocated using \t// page_alloc. Pages allocated at boot time using pmap.c's \"alloc\" \t// do not have valid reference count fields.  u_short pp_ref; }; extern struct Page *pages; static inline u_long page2ppn(struct Page *pp) { return pp - pages; } static inline u_long page2pa(struct Page *pp) { return page2ppn(pp)PGSHIFT; } static inline struct Page * pa2page(u_long pa) { if (PPN(pa) = npage) panic(\"pa2page called with invalid pa: %x\", pa); return \u0026pages[PPN(pa)]; } static inline u_long page2kva(struct Page *pp) { return KADDR(page2pa(pp)); } static inline u_long va2pa(Pde *pgdir, u_long va) { Pte *p; pgdir = \u0026pgdir[PDX(va)]; if (!(*pgdir\u0026PTE_V)) return ~0; p = (Pte*)KADDR(PTE_ADDR(*pgdir)); if (!(p[PTX(va)]\u0026PTE_V)) return ~0; return PTE_ADDR(p[PTX(va)]); }   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  #define ULIM 0x80000000 #define PADDR(kva)\t\\ ({\t\\ u_long a = (u_long) (kva);\t\\ if (a panic(\"PADDR called with invalid kva %08lx\", a);\\ a - ULIM;\t\\ })  // translates from physical address to kernel virtual address #define KADDR(pa)\t\\ ({\t\\ u_long ppn = PPN(pa);\t\\ if (ppn = npage)\t\\ panic(\"KADDR called with invalid pa %08lx\", (u_long)pa);\\ (pa) + ULIM;\t\\ })   Exercise exercise 3.1  ä½¿ç”¨boot_map_segmentè¿›è¡Œæ®µæ˜ å°„ï¼Œenvs æ•°ç»„åº”è¯¥è¢«UENVS åŒºåŸŸæ˜ å°„  exercise 3.2  ä½¿ç”¨envså‡½æ•°ï¼Œæ³¨æ„queue.hå‡½æ•°è°ƒç”¨çš„å‚æ•°ç±»å‹ã€‚ æ’å…¥é¡ºåºä¸ºå€’åº  exercise 3.3 å…³äºasid_allocå‡½æ•° asid_alloc å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯ä¸ºæ–°åˆ›å»ºçš„è¿›ç¨‹åˆ†é…ä¸€ä¸ªå¼‚äºå½“å‰æ‰€æœ‰æœªè¢«é‡Šæ”¾çš„è¿›ç¨‹çš„ ASIDã€‚\n  è¿™ä¸ª ASIDæ˜¯ä»€ä¹ˆï¼Ÿ\n  ä¸ºä»€ä¹ˆè¦ä¸å…¶ä»–çš„è¿›ç¨‹ä¸åŒå‘¢ï¼Ÿ\n  æ ¹æ® lab2 çš„å­¦ä¹ æˆ‘ä»¬å¾—çŸ¥è¿›ç¨‹æ˜¯é€šè¿‡é¡µè¡¨æ¥è®¿é—®å†…å­˜çš„ï¼Œè€Œä¸åŒçš„è¿›ç¨‹çš„åŒä¸€ä¸ªè™šæ‹Ÿåœ°å€å¯èƒ½ä¼šæ˜ å°„åˆ°ä¸åŒçš„ç‰©ç†åœ°å€ã€‚\nä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ï¼ŒTLB ä¸­é™¤äº†å­˜å‚¨é¡µè¡¨çš„æ˜ å°„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜ä¼šå­˜å‚¨è¿›ç¨‹çš„æ ‡è¯†ç¼–å·ï¼Œä½œä¸º Key çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºä¿è¯æŸ¥åˆ°çš„é¡µé¢æ˜ å°„å±äºå½“å‰è¿›ç¨‹ï¼Œè€Œè¿™ä¸ªç¼–å·å°±æ˜¯ASIDã€‚æ˜¾ç„¶ï¼Œä¸åŒè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€æ˜¯å¯ä»¥å¯¹åº”ç›¸åŒ VPN çš„ï¼Œè€Œå¦‚æœ ASID ä¹Ÿä¸å…·å¤‡å”¯ä¸€æ ‡è¯†æ€§ï¼Œå°±ä¸ TLB Field çš„å”¯ä¸€æ€§è¦æ±‚ç›¸çŸ›ç›¾äº†ã€‚å› æ­¤ï¼Œç›´åˆ°è¿›ç¨‹è¢«é”€æ¯æˆ– TLB è¢«æ¸…ç©ºæ—¶ï¼Œæ‰å¯ä»¥æŠŠè¿™ä¸ª ASID åˆ†é…ç»™å…¶ä»–è¿›ç¨‹ã€‚\n ä¸ºä»€ä¹ˆä¸èƒ½ç®€å•çš„é€šè¿‡è‡ªå¢æ¥é¿å…å†²çªå‘¢ï¼Ÿ  ç®€å•çš„å›ç­”ï¼šç”¨æ¥å­˜å‚¨ASIDçš„ä½æ•°æœ‰é™ï¼Œè‡ªå¢å®¹æ˜“å‘ç”Ÿæº¢å‡º\nexercise 3.4 env_setup_vm 1 2 3 4 5 6 7 8 9  static int env_setup_vm(struct Env *e); for (i = 0; i  PDX(UTOP); i++){ pgdir[i] = 0; } for (i = PDX(UTOP); iPTE2PT; i++){ if (i != PDX(VPT) \u0026\u0026 i != PDX(UVPT)) pgdir[i] = boot_pgdir[i]; }    å¾ˆå¤šç–‘é—® å…³äºboot_pgdir  exercise 3.5 env_alloc 1 2  // è®¾ç½®spå¯„å­˜å™¨ e-env_tf.regs[29] = USTACKTOP;   exercise 3.6 load_icode_mapper\t è°ƒç”¨é“¾ï¼šload_icode - load_elf - load_icode_mapper\nexercise 3.7 load_elfå’Œload_icode exercise 3.8 env_create å’Œenv_create_priority è°ƒç”¨é“¾ï¼šenv_create - env_create_priority\nexercise 3.9 mips_init exercise 3.10 env_run exercise 3.11 page_init Thinking Thinking 3.1 æ€è€ƒenvid2env å‡½æ•°:\nä¸ºä»€ä¹ˆenvid2env ä¸­éœ€è¦åˆ¤æ–­e-env_id != envid çš„æƒ…å†µï¼Ÿå¦‚æœæ²¡æœ‰è¿™æ­¥åˆ¤æ–­ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿ\n envidå¯èƒ½å¤§äº64 æ²¡æœ‰è¿™ä¸€æ­¥å¯èƒ½å¯¼è‡´éå†…å­˜æ§åˆ¶å¿«çš„å†…å­˜åœ°å€è¢«è½¬æ¢  Thinking 3.2 ç»“åˆinclude/mmu.h ä¸­çš„åœ°å€ç©ºé—´å¸ƒå±€ï¼Œæ€è€ƒenv_setup_vm å‡½æ•°ï¼š\n UTOP å’ŒULIM çš„å«ä¹‰åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼ŒUTOP å’ŒULIM ä¹‹é—´çš„åŒºåŸŸä¸UTOPä»¥ä¸‹çš„åŒºåŸŸç›¸æ¯”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ   ULIMä»¥ä¸Šæ˜¯å†…æ ¸æ€ UTOPä¸ULIMä¹‹é—´æœ‰ä¸‰ä¸ªé¡µè¡¨ ULIMä¹‹ä¸‹çš„æ˜¯æ ˆï¼ŒUTOPå’ŒULIMä¹‹é—´çš„åŒºåŸŸæ˜¯é¡µè¡¨   è¯·ç»“åˆç³»ç»Ÿè‡ªæ˜ å°„æœºåˆ¶è§£é‡Šä»£ç ä¸­pgdir[PDX(UVPT)]=env_cr3çš„å«ä¹‰ã€‚  è‡ªèº«æ˜ å°„åˆ°è‡ªèº«\n è°ˆè°ˆè‡ªå·±å¯¹è¿›ç¨‹ä¸­ç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€çš„ç†è§£ã€‚  ä¹‹é—´æœ‰æ˜ å°„å…³ç³»ã€‚\nThinking 3.3 æ‰¾åˆ° user_data è¿™ä¸€å‚æ•°çš„æ¥æºï¼Œæ€è€ƒå®ƒçš„ä½œç”¨ã€‚æ²¡æœ‰è¿™ä¸ªå‚æ•°å¯ä¸å¯ä»¥ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿï¼ˆå¯ä»¥å°è¯•è¯´æ˜å®é™…çš„åº”ç”¨åœºæ™¯ï¼Œä¸¾ä¸€ä¸ªå®é™…çš„åº“ä¸­çš„ä¾‹å­ï¼‰\n ä¸ºload_icode_mapperä¼ å‚  Thinking 3.4 ç»“åˆload_icode_mapper çš„å‚æ•°ä»¥åŠäºŒè¿›åˆ¶é•œåƒçš„å¤§å°ï¼Œè€ƒè™‘è¯¥å‡½æ•°å¯èƒ½ä¼šé¢ä¸´å“ªå‡ ç§å¤åˆ¶çš„æƒ…å†µï¼Ÿä½ æ˜¯å¦éƒ½è€ƒè™‘åˆ°äº†ï¼Ÿ\n vaä¸ä¸é¡µå¯¹å…¶ va+binsizeä¸ä¸é¡µé¢å¯¹é½  Thinking 3.5 æ€è€ƒä¸Šé¢è¿™ä¸€æ®µè¯ï¼Œå¹¶æ ¹æ®è‡ªå·±åœ¨lab2 ä¸­çš„ç†è§£ï¼Œå›ç­”ï¼š\n ä½ è®¤ä¸ºè¿™é‡Œçš„ env_tf.pc å­˜å‚¨çš„æ˜¯ç‰©ç†åœ°å€è¿˜æ˜¯è™šæ‹Ÿåœ°å€?  æ˜¯è™šæ‹Ÿåœ°å€\n ä½ è§‰å¾—entry_pointå…¶å€¼å¯¹äºæ¯ä¸ªè¿›ç¨‹æ˜¯å¦ä¸€æ ·ï¼Ÿè¯¥å¦‚ä½•ç†è§£è¿™ç§ç»Ÿä¸€æˆ–ä¸åŒ  ä¸ä¸€å®šç›¸åŒï¼Œå¯¹ä¸åŒçš„elfæ–‡ä»¶entry_pointä¸åŒã€‚\nThinking 3.6 è¯·æŸ¥é˜…ç›¸å…³èµ„æ–™è§£é‡Šï¼Œä¸Šé¢æåˆ°çš„epcæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦å°†env_tf.pcè®¾ç½®ä¸ºepcå‘¢ï¼Ÿ\nThinking 3.7 å…³äº TIMESTACKï¼Œè¯·æ€è€ƒä»¥ä¸‹é—®é¢˜ï¼š\n æ“ä½œç³»ç»Ÿåœ¨ä½•æ—¶å°†ä»€ä¹ˆå†…å®¹å­˜åˆ°äº† TIMESTACK åŒºåŸŸ TIMESTACK å’Œ env_asm.S ä¸­æ‰€å®šä¹‰çš„ KERNEL_SP çš„å«ä¹‰æœ‰ä½•ä¸åŒ  Thinking 3.8 è¯•æ‰¾å‡ºä¸Šè¿° 5 ä¸ªå¼‚å¸¸å¤„ç†å‡½æ•°çš„å…·ä½“å®ç°ä½ç½®ã€‚\n   å¼‚å¸¸å· å¤„ç†å‡½æ•° å«ä¹‰ å…·ä½“å®ç°ä½ç½® å¤‡æ³¨     0 handle_int è¡¨ç¤ºä¸­æ–­ï¼Œç”±æ—¶é’Ÿä¸­æ–­ã€æ§åˆ¶å°ä¸­æ–­ç­‰ä¸­æ–­é€ æˆ ./lib/genex.S    1 handle_mod è¡¨ç¤ºå­˜å‚¨å¼‚å¸¸ï¼Œè¿›è¡Œå­˜å‚¨æ“ä½œæ—¶è¯¥é¡µè¢«æ ‡è®°ä¸ºåªè¯» ./lib/genex.S    2 handle_tlb TLB å¼‚å¸¸ï¼ŒTLB ä¸­æ²¡æœ‰å’Œç¨‹åºåœ°å€åŒ¹é…çš„æœ‰æ•ˆå…¥å£ ./lib/genex.S    3 handle_tlb TLB å¼‚å¸¸ï¼ŒTLB å¤±æ•ˆï¼Œä¸”æœªå¤„äºå¼‚å¸¸æ¨¡å¼ï¼ˆç”¨äºæé«˜å¤„ç†æ•ˆç‡ï¼‰ ./lib/genex.S    8 handle_sys ç³»ç»Ÿè°ƒç”¨ï¼Œé™·å…¥å†…æ ¸ï¼Œæ‰§è¡Œäº† syscall æŒ‡ä»¤ ./lib/syscall.S     Thinking 3.9 é˜…è¯» kclock_asm.S å’Œ genex.S ä¸¤ä¸ªæ–‡ä»¶ï¼Œå¹¶å°è¯•è¯´å‡º set_timer å’Œtimer_irq å‡½æ•°ä¸­æ¯è¡Œæ±‡ç¼–ä»£ç çš„ä½œç”¨\nset_timer 1 2 3 4 5 6 7 8 9 10  LEAF(set_timer) li t0, 0xc8 sb t0, 0xb5000100\t// å‘0xb5000100 ä½ç½®å†™å…¥0xc8 sw\tsp, KERNEL_SP\t// å°†å½“å‰æ ˆæŒ‡é’ˆä¿å­˜åˆ°KERNEL_SP setup_c0_status STATUS_CU0|0x1001 0\t// è°ƒç”¨setup_c0_statuså‡½æ•° jr ra nop END(set_timer)   time_irq 1 2 3 4 5 6 7 8 9 10 11 12 13  timer_irq: sb zero, 0xb5000110\t// åœ¨0xb5000110å†™å…¥0 1:\tj\tsched_yield\t// è·³è½¬åˆ°sched_ yield nop /*li t1, 0xff lw t0, delay addu t0, 1 sw\tt0, delay beq\tt0,t1,1f\tnop*/ j\tret_from_exception\tnop   è¦äº§ç”Ÿæ—¶é’Ÿä¸­æ–­ï¼Œæˆ‘ä»¬ä¸ä»…è¦äº†è§£ä¸­æ–­çš„äº§ç”Ÿä¸å¤„ç†ï¼Œè¿˜è¦äº†è§£ gxemul æ˜¯å¦‚ä½•æ¨¡æ‹Ÿæ—¶é’Ÿä¸­æ–­çš„ã€‚kclock_init å‡½æ•°å®Œæˆäº†æ—¶é’Ÿçš„åˆå§‹åŒ–ï¼Œè¯¥å‡½æ•°ä¸»è¦è°ƒç”¨ set_timer å‡½æ•°ï¼Œå®Œæˆå¦‚ä¸‹æ“ä½œï¼š\n é¦–å…ˆå‘0xb5000100 ä½ç½®å†™å…¥0xc8ï¼Œå…¶ä¸­0xb5000000 æ˜¯æ¨¡æ‹Ÿå™¨(gxemul) æ˜ å°„å®æ—¶é’Ÿçš„ä½ç½®ã€‚åç§»é‡ä¸º0x100 è¡¨ç¤ºæ¥è®¾ç½®å®æ—¶é’Ÿä¸­æ–­çš„é¢‘ç‡ï¼Œ0xc8 åˆ™è¡¨ç¤º1 ç§’é’Ÿä¸­æ–­200æ¬¡ï¼Œå¦‚æœå†™å…¥0ï¼Œè¡¨ç¤ºå…³é—­å®æ—¶é’Ÿã€‚å®æ—¶é’Ÿå¯¹äºR3000 æ¥è¯´ç»‘å®šåˆ°äº†4 å·ä¸­æ–­ä¸Šï¼Œæ•…è¿™æ®µä»£ç å…¶å®ä¸»è¦ç”¨æ¥è§¦å‘äº†4 å·ä¸­æ–­ã€‚æ³¨æ„è¿™é‡Œçš„ä¸­æ–­å·å’Œå¼‚å¸¸å·æ˜¯ä¸ä¸€æ ·çš„æ¦‚å¿µï¼Œæˆ‘ä»¬å®éªŒçš„å¼‚å¸¸åŒ…æ‹¬ä¸­æ–­ã€‚ ä¸€æ—¦å®æ—¶é’Ÿä¸­æ–­äº§ç”Ÿï¼Œå°±ä¼šè§¦å‘MIPS ä¸­æ–­ï¼Œä»è€ŒMIPS å°†PC æŒ‡å‘0x80000080ï¼Œä»è€Œè·³è½¬åˆ°.text.exc_vec3ä»£ç æ®µæ‰§è¡Œã€‚å¯¹äºå®æ—¶é’Ÿå¼•èµ·çš„ä¸­æ–­ï¼Œé€šè¿‡.text.exc_vec3ä»£ç æ®µçš„åˆ†å‘ï¼Œæœ€ç»ˆä¼šè°ƒç”¨handle_ int å‡½æ•°æ¥å¤„ç†å®æ—¶é’Ÿä¸­æ–­ã€‚ åœ¨handle_ int åˆ¤æ–­CP0_CAUSEå¯„å­˜å™¨æ˜¯ä¸æ˜¯å¯¹åº”çš„4 å·ä¸­æ–­ä½å¼•å‘çš„ä¸­æ–­ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ‰§è¡Œä¸­æ–­æœåŠ¡å‡½æ•°timer_ irqã€‚ åœ¨timer_ irq é‡Œç›´æ¥è·³è½¬åˆ°sched_ yield ä¸­æ‰§è¡Œã€‚è€Œè¿™ä¸ªå‡½æ•°å°±æ˜¯æˆ‘ä»¬å°†è¦è¡¥å……çš„è°ƒåº¦å‡½æ•°ã€‚  SAVE_ALL 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64  .macro SAVE_ALL // å‰å››è¡Œå…¶é¦–å…ˆå–å‡ºäº† SR å¯„å­˜å™¨çš„å€¼, ç„¶ååˆ©ç”¨ç§»ä½ç­‰æ“ä½œåˆ¤æ–­ç¬¬ 28 ä½çš„å€¼, æ ¹æ®å‰é¢çš„è®²è¿°æˆ‘ä»¬å¯ä»¥çŸ¥é“, ä¹Ÿå³åˆ¤æ–­å½“å‰æ˜¯å¦å¤„äºç”¨æˆ·æ¨¡å¼ä¸‹ã€‚5 mfc0\tk0,CP0_STATUS sll\tk0,3 /* extract cu0 bit */ bltz\tk0,1f nop /* * Called from user mode, new stack */ // lui\tk1,%hi(kernelsp) // lw\tk1,%lo(kernelsp)(k1) //not clear right now // æ¥ä¸‹æ¥å°†å½“å‰è¿è¡Œæ ˆçš„åœ°å€ä¿å­˜åˆ° k0 ä¸­ï¼›ç„¶åè°ƒç”¨ get_sp å®ï¼Œæ ¹æ®ä¸­æ–­å¼‚å¸¸çš„ç§ç±»åˆ¤æ–­éœ€è¦ä¿å­˜çš„ä½ç½®ï¼Œå¹¶åˆ†é…ä¸€å®šçš„ç©ºé—´ï¼›å°†ä¹‹å‰çš„è¿è¡Œæ ˆåœ°å€ä¸ 2 å·å¯„å­˜å™¨ $v0 å…ˆä¿å­˜èµ·æ¥ï¼Œä¾¿äºåé¢å¯ä»¥æ”¾å¿ƒçš„ä½¿ç”¨ sp å¯„å­˜å™¨ä¸ v0 å¯„å­˜å™¨ã€‚ 1: move\tk0,sp get_sp move\tk1,sp subu\tsp,k1,TF_SIZE sw\tk0,TF_REG29(sp) sw\t$2,TF_REG2(sp) mfc0\tv0,CP0_STATUS sw\tv0,TF_STATUS(sp) mfc0\tv0,CP0_CAUSE sw\tv0,TF_CAUSE(sp) mfc0\tv0,CP0_EPC sw\tv0,TF_EPC(sp) mfc0\tv0, CP0_BADVADDR sw\tv0, TF_BADVADDR(sp) mfhi\tv0 sw\tv0,TF_HI(sp) mflo\tv0 sw\tv0,TF_LO(sp) sw\t$0,TF_REG0(sp) sw\t$1,TF_REG1(sp) //sw\t$2,TF_REG2(sp) sw\t$3,TF_REG3(sp) sw\t$4,TF_REG4(sp) sw\t$5,TF_REG5(sp) sw\t$6,TF_REG6(sp) sw\t$7,TF_REG7(sp) sw\t$8,TF_REG8(sp) sw\t$9,TF_REG9(sp) sw\t$10,TF_REG10(sp) sw\t$11,TF_REG11(sp) sw\t$12,TF_REG12(sp) sw\t$13,TF_REG13(sp) sw\t$14,TF_REG14(sp) sw\t$15,TF_REG15(sp) sw\t$16,TF_REG16(sp) sw\t$17,TF_REG17(sp) sw\t$18,TF_REG18(sp) sw\t$19,TF_REG19(sp) sw\t$20,TF_REG20(sp) sw\t$21,TF_REG21(sp) sw\t$22,TF_REG22(sp) sw\t$23,TF_REG23(sp) sw\t$24,TF_REG24(sp) sw\t$25,TF_REG25(sp) sw\t$26,TF_REG26(sp) sw\t$27,TF_REG27(sp) sw\t$28,TF_REG28(sp) sw\t$30,TF_REG30(sp) sw\t$31,TF_REG31(sp) .endm   å†…å­˜åœ°å›¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43  /* o 4G ----------- +----------------------------+------------0x100000000 o | ... | kseg3 o +----------------------------+------------0xe000 0000 o | ... | kseg2 o +----------------------------+------------0xc000 0000 o | Interrupts \u0026 Exception | kseg1 o +----------------------------+------------0xa000 0000 o | Invalid memory | /|\\ o +----------------------------+----|-------Physics Memory Max o | ... | kseg0 o VPT,KSTACKTOP----- +----------------------------+----|-------0x8040 0000-------end o | Kernel Stack | | KSTKSIZE /|\\ o +----------------------------+----|------ | o | Kernel Text | | PDMAP o KERNBASE ----- +----------------------------+----|-------0x8001 0000 | o | Interrupts \u0026 Exception | \\|/ \\|/ o ULIM ----- +----------------------------+------------0x8000 0000------- o | User VPT | PDMAP /|\\ o UVPT ----- +----------------------------+------------0x7fc0 0000 | o | PAGES | PDMAP | o UPAGES ----- +----------------------------+------------0x7f80 0000 | o | ENVS | PDMAP | o UTOP,UENVS ----- +----------------------------+------------0x7f40 0000 | o UXSTACKTOP -/ | user exception stack | BY2PG | o +----------------------------+------------0x7f3f f000 | o | Invalid memory | BY2PG | o USTACKTOP ---- +----------------------------+------------0x7f3f e000 | o | normal user stack | BY2PG | o +----------------------------+------------0x7f3f d000 | a | | | a ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ | a . . | a . . kuseg a . . | a |~~~~~~~~~~~~~~~~~~~~~~~~~~~~| | a | | | o UTEXT ----- +----------------------------+ | o | | 2 * PDMAP \\|/ a 0 ------------ +----------------------------+ ----------------------------- o */    boot_pgdir è¢«æ˜ å°„åˆ°UPAGES envsè¢«æ˜ å°„åˆ°UENVS  04000000\nå¼‚å¸¸ä¸ä¸­æ–­ æˆ‘ä»¬å®éªŒé‡Œè®¤ä¸ºå‡¡æ˜¯å¼•èµ·æ§åˆ¶æµçªå˜çš„éƒ½å«åšå¼‚å¸¸ï¼Œè€Œä¸­æ–­ä»…ä»…æ˜¯å¼‚å¸¸çš„ä¸€ç§ï¼Œå¹¶ä¸”æ˜¯ä»…æœ‰çš„ä¸€ç§å¼‚æ­¥å¼‚å¸¸ã€‚\nå¼‚å¸¸çš„äº§ç”Ÿä¸è¿”å› ","wordCount":"4032","inLanguage":"en","datePublished":"2022-05-08T17:43:03+08:00","dateModified":"2022-05-08T17:43:03+08:00","author":[{"@type":"Person","name":"Appletea"}],"mainEntityOfPage":{"@type":"WebPage","@id":"http://appletea233.github.io/myblog_hogo/posts/blog/%E6%96%87%E6%A1%A3/"},"publisher":{"@type":"Organization","name":"Appletea's Blog","logo":{"@type":"ImageObject","url":"http://appletea233.github.io/myblog_hogo/img/Q.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://appletea233.github.io/myblog_hogo accesskey=h title="Appletea's Blog (Alt + H)">Appletea's Blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=http://appletea233.github.io/myblog_hogo/search title="ğŸ”æœç´¢ (Alt + /)" accesskey=/><span>ğŸ”æœç´¢</span></a></li><li><a href=http://appletea233.github.io/myblog_hogo/ title=ğŸ ä¸»é¡µ><span>ğŸ ä¸»é¡µ</span></a></li><li><a href=http://appletea233.github.io/myblog_hogo/posts title=ğŸ“šæ–‡ç« ><span>ğŸ“šæ–‡ç« </span></a></li><li><a href=http://appletea233.github.io/myblog_hogo/archives/ title=â±æ—¶é—´è½´><span>â±æ—¶é—´è½´</span></a></li><li><a href=http://appletea233.github.io/myblog_hogo/tags title=ğŸ”–æ ‡ç­¾><span>ğŸ”–æ ‡ç­¾</span></a></li><li><a href=http://appletea233.github.io/myblog_hogo/about title=ğŸ™‹ğŸ»â€â™‚ï¸å…³äº><span>ğŸ™‹ğŸ»â€â™‚ï¸å…³äº</span></a></li><li><a href=http://appletea233.github.io/myblog_hogo/links title=ğŸ¤å‹é“¾><span>ğŸ¤å‹é“¾</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://appletea233.github.io/myblog_hogo>Home</a>&nbsp;Â»&nbsp;<a href=http://appletea233.github.io/myblog_hogo/posts/>ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href=http://appletea233.github.io/myblog_hogo/posts/blog/>Blog</a></div><h1 class=post-title>BUAAæ“ä½œç³»ç»Ÿlab3ç¬”è®°</h1><div class=post-description>å¦‚é¢˜</div><div class=post-meta>åˆ›å»º:&nbsp;<span title="2022-05-08 17:43:03 +0800 +0800">2022-05-08</span>&nbsp;æ›´æ–°:&nbsp;2022-05-08&nbsp;å­—æ•°:&nbsp;4032å­—&nbsp;æ—¶é•¿:&nbsp;9åˆ†é’Ÿ&nbsp;<br>ä½œè€…:&nbsp;Appletea&nbsp;æ ‡ç­¾:
<a href=http://appletea233.github.io/myblog_hogo/tags/study>study</a>
<a href=http://appletea233.github.io/myblog_hogo/tags/os>os</a>
æœ¬æ–‡æ€»é˜…è¯»é‡:&nbsp<span id=busuanzi_value_page_pv></span>æ¬¡</p></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><ul><li><a href=#%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%e5%85%b3%e7%b3%bb aria-label=å‡½æ•°è°ƒç”¨å…³ç³»>å‡½æ•°è°ƒç”¨å…³ç³»</a></li><li><a href=#%e7%bb%93%e6%9e%84%e4%bd%93%e4%bf%a1%e6%81%af aria-label=ç»“æ„ä½“ä¿¡æ¯>ç»“æ„ä½“ä¿¡æ¯</a><ul><li><a href=#page aria-label=Page>Page</a></li><li><a href=#trapframe aria-label=Trapframe>Trapframe</a></li><li><a href=#env aria-label=Env>Env</a></li></ul></li><li><a href=#ehdr%e4%b8%8ephdr aria-label=Ehdrä¸Phdr>Ehdrä¸Phdr</a><ul><li><a href=#%e4%b8%80%e4%ba%9b%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8f aria-label=ä¸€äº›å…¨å±€å˜é‡>ä¸€äº›å…¨å±€å˜é‡</a></li></ul></li><li><a href=#%e5%8f%98%e9%87%8f%e8%bd%ac%e6%8d%a2 aria-label=å˜é‡è½¬æ¢>å˜é‡è½¬æ¢</a></li></ul><li><a href=#exercise aria-label=Exercise>Exercise</a><ul><li><a href=#exercise-31 aria-label="exercise 3.1">exercise 3.1</a></li><li><a href=#exercise-32 aria-label="exercise 3.2">exercise 3.2</a></li><li><a href=#exercise-33 aria-label="exercise 3.3">exercise 3.3</a><ul><li><a href=#%e5%85%b3%e4%ba%8easid_alloc%e5%87%bd%e6%95%b0 aria-label=å…³äºasid_allocå‡½æ•°>å…³äº<code>asid_alloc</code>å‡½æ•°</a></li></ul></li><li><a href=#exercise-34-env_setup_vm aria-label="exercise 3.4 env_setup_vm">exercise 3.4 <code>env_setup_vm</code></a></li><li><a href=#exercise-35-env_alloc aria-label="exercise 3.5 env_alloc">exercise 3.5 <code>env_alloc</code></a></li><li><a href=#exercise-36-load_icode_mapper aria-label="exercise 3.6 load_icode_mapper	">exercise 3.6 <code>load_icode_mapper</code></a></li><li><a href=#exercise-37-load_elf%e5%92%8cload_icode aria-label="exercise 3.7 load_elfå’Œload_icode">exercise 3.7 <code>load_elf</code>å’Œ<code>load_icode</code></a></li><li><a href=#exercise-38-env_create-%e5%92%8cenv_create_priority aria-label="exercise 3.8 env_create å’Œenv_create_priority">exercise 3.8 <code>env_create </code>å’Œ<code>env_create_priority</code></a></li><li><a href=#exercise-39-mips_init aria-label="exercise 3.9 mips_init">exercise 3.9 <code>mips_init</code></a></li><li><a href=#exercise-310-env_run aria-label="exercise 3.10 env_run">exercise 3.10 <code>env_run</code></a></li><li><a href=#exercise-311-page_init aria-label="exercise 3.11 page_init">exercise 3.11 <code>page_init</code></a></li></ul></li><li><a href=#thinking aria-label=Thinking>Thinking</a><ul><li><a href=#thinking-31 aria-label="Thinking 3.1">Thinking 3.1</a></li><li><a href=#thinking-32 aria-label="Thinking 3.2">Thinking 3.2</a></li><li><a href=#thinking-33 aria-label="Thinking 3.3">Thinking 3.3</a></li><li><a href=#thinking-34 aria-label="Thinking 3.4">Thinking 3.4</a></li><li><a href=#thinking-35 aria-label="Thinking 3.5">Thinking 3.5</a></li><li><a href=#thinking-36 aria-label="Thinking 3.6">Thinking 3.6</a></li><li><a href=#thinking-37 aria-label="Thinking 3.7">Thinking 3.7</a></li><li><a href=#thinking-38 aria-label="Thinking 3.8">Thinking 3.8</a></li><li><a href=#thinking-39 aria-label="Thinking 3.9">Thinking 3.9</a><ul><li><a href=#set_timer aria-label=set_timer>set_timer</a></li><li><a href=#time_irq aria-label=time_irq>time_irq</a></li><li><a href=#save_all aria-label=SAVE_ALL>SAVE_ALL</a></li></ul></li></ul></li><li><a href=#%e5%86%85%e5%ad%98%e5%9c%b0%e5%9b%be aria-label=å†…å­˜åœ°å›¾>å†…å­˜åœ°å›¾</a></li><li><a href=#%e5%bc%82%e5%b8%b8%e4%b8%8e%e4%b8%ad%e6%96%ad aria-label=å¼‚å¸¸ä¸ä¸­æ–­>å¼‚å¸¸ä¸ä¸­æ–­</a><ul><li><a href=#%e5%bc%82%e5%b8%b8%e7%9a%84%e4%ba%a7%e7%94%9f%e4%b8%8e%e8%bf%94%e5%9b%9e aria-label=å¼‚å¸¸çš„äº§ç”Ÿä¸è¿”å›>å¼‚å¸¸çš„äº§ç”Ÿä¸è¿”å›</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const e=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${e}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h3 id=å‡½æ•°è°ƒç”¨å…³ç³»>å‡½æ•°è°ƒç”¨å…³ç³»<a hidden class=anchor aria-hidden=true href=#å‡½æ•°è°ƒç”¨å…³ç³»>#</a></h3><p><img loading=lazy src=../%e6%96%87%e6%a1%a3.assets/image-20220427155529203.png alt=image-20220427155529203></p><h3 id=ç»“æ„ä½“ä¿¡æ¯>ç»“æ„ä½“ä¿¡æ¯<a hidden class=anchor aria-hidden=true href=#ç»“æ„ä½“ä¿¡æ¯>#</a></h3><h4 id=page>Page<a hidden class=anchor aria-hidden=true href=#page>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>Page_list</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>struct</span> <span class=n>Page</span> <span class=o>*</span><span class=n>le_next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>struct</span> <span class=n>Page</span> <span class=n>le_prev</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=n>pp_link</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>u_short</span> <span class=n>pp_ref</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=o>*</span> <span class=n>lh_first</span><span class=p>;</span> <span class=c1>// Page*
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>Env_list</code>ç»“æ„ä¸ä¹‹ç±»ä¼¼</li></ul><h4 id=trapframe>Trapframe<a hidden class=anchor aria-hidden=true href=#trapframe>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>Trapframe</span> <span class=p>{</span> <span class=c1>//lr:need to be modified(reference to linux pt_regs) TODO
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=cm>/* Saved main processor registers. */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>regs</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Saved special registers. */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>cp0_status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>hi</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>lo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>cp0_badvaddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>cp0_cause</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>cp0_epc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>pc</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=env>Env<a hidden class=anchor aria-hidden=true href=#env>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>Env</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=k>struct</span> <span class=n>Trapframe</span> <span class=n>env_tf</span><span class=p>;</span>       <span class=c1>// Saved registers 
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=n>LIST_ENTRY</span><span class=p>(</span><span class=n>Env</span><span class=p>)</span> <span class=n>env_link</span><span class=p>;</span>      <span class=c1>// Free LIST_ENTRY 
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=n>u_int</span> <span class=n>env_id</span><span class=p>;</span>                  <span class=c1>// Unique environment identifier 
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=n>u_int</span> <span class=n>env_parent_id</span><span class=p>;</span>           <span class=c1>// env_id of this env&#39;s parent 
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=n>u_int</span> <span class=n>env_status</span><span class=p>;</span>              <span class=c1>// Status of the environment 
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=n>Pde</span> <span class=o>*</span><span class=n>env_pgdir</span><span class=p>;</span>                <span class=c1>// Kernel virtual address of page dir 
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=n>u_int</span> <span class=n>env_cr3</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>     <span class=n>LIST_ENTRY</span><span class=p>(</span><span class=n>Env</span><span class=p>)</span> <span class=n>env_sched_link</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>     <span class=n>u_int</span> <span class=n>env_pri</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>env_status : è¯¥å˜é‡åªèƒ½æœ‰ä»¥ä¸‹ä¸‰ç§å–å€¼ï¼š</li></ul><ol><li>ENV_FREE : è¡¨æ˜è¯¥è¿›ç¨‹æ˜¯ä¸æ´»åŠ¨çš„ï¼Œå³è¯¥è¿›ç¨‹æ§åˆ¶å—å¤„äºè¿›ç¨‹ç©ºé—²é“¾è¡¨ä¸­ã€‚</li><li>ENV_NOT_RUNNABLE : è¡¨æ˜è¯¥è¿›ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œå¤„äºè¯¥çŠ¶æ€çš„è¿›ç¨‹éœ€è¦åœ¨ä¸€å®šæ¡ä»¶ä¸‹å˜æˆå°±ç»ªçŠ¶æ€ä»è€Œè¢«CPUè°ƒåº¦ã€‚ï¼ˆæ¯”å¦‚å› è¿›ç¨‹é€šä¿¡é˜»å¡æ—¶å˜ä¸º ENV_NOT_RUNNABLEï¼Œæ”¶åˆ°ä¿¡æ¯åå˜å› ENV_RUNNABLEï¼‰</li><li>ENV_RUNNABLE : è¡¨æ˜è¯¥è¿›ç¨‹å¤„äºæ‰§è¡ŒçŠ¶æ€æˆ–å°±ç»ªçŠ¶æ€ï¼Œå³å…¶å¯èƒ½æ˜¯æ­£åœ¨è¿è¡Œçš„ï¼Œä¹Ÿå¯èƒ½æ­£åœ¨ç­‰å¾…è¢«è°ƒåº¦ã€‚</li></ol><h3 id=ehdrä¸phdr>Ehdrä¸Phdr<a hidden class=anchor aria-hidden=true href=#ehdrä¸phdr>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>char</span>	<span class=n>e_ident</span><span class=p>[</span><span class=n>EI_NIDENT</span><span class=p>];</span>	<span class=cm>/* Magic number and other info */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Half</span>	<span class=n>e_type</span><span class=p>;</span>			<span class=cm>/* Object file type */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Half</span>	<span class=n>e_machine</span><span class=p>;</span>		<span class=cm>/* Architecture */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Word</span>	<span class=n>e_version</span><span class=p>;</span>		<span class=cm>/* Object file version */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Addr</span>	<span class=n>e_entry</span><span class=p>;</span>		<span class=cm>/* Entry point virtual address */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Off</span>	<span class=n>e_phoff</span><span class=p>;</span>		<span class=cm>/* Program header table file offset */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Off</span>	<span class=n>e_shoff</span><span class=p>;</span>		<span class=cm>/* Section header table file offset */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Word</span>	<span class=n>e_flags</span><span class=p>;</span>		<span class=cm>/* Processor-specific flags */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Half</span>	<span class=n>e_ehsize</span><span class=p>;</span>		<span class=cm>/* ELF header size in bytes */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Half</span>	<span class=n>e_phentsize</span><span class=p>;</span>		<span class=cm>/* Program header table entry size */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Half</span>	<span class=n>e_phnum</span><span class=p>;</span>		<span class=cm>/* Program header table entry count */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Half</span>	<span class=n>e_shentsize</span><span class=p>;</span>		<span class=cm>/* Section header table entry size */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Half</span>	<span class=n>e_shnum</span><span class=p>;</span>		<span class=cm>/* Section header table entry count */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Half</span>	<span class=n>e_shstrndx</span><span class=p>;</span>		<span class=cm>/* Section header string table index */</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>Elf32_Ehdr</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Word</span>	<span class=n>p_type</span><span class=p>;</span>			<span class=cm>/* Segment type */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Off</span>	<span class=n>p_offset</span><span class=p>;</span>		<span class=cm>/* Segment file offset */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Addr</span>	<span class=n>p_vaddr</span><span class=p>;</span>		<span class=cm>/* Segment virtual address */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Addr</span>	<span class=n>p_paddr</span><span class=p>;</span>		<span class=cm>/* Segment physical address */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Word</span>	<span class=n>p_filesz</span><span class=p>;</span>		<span class=cm>/* Segment size in file */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Word</span>	<span class=n>p_memsz</span><span class=p>;</span>		<span class=cm>/* Segment size in memory */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Word</span>	<span class=n>p_flags</span><span class=p>;</span>		<span class=cm>/* Segment flags */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Word</span>	<span class=n>p_align</span><span class=p>;</span>		<span class=cm>/* Segment alignment */</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>Elf32_Phdr</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=ä¸€äº›å…¨å±€å˜é‡>ä¸€äº›å…¨å±€å˜é‡<a hidden class=anchor aria-hidden=true href=#ä¸€äº›å…¨å±€å˜é‡>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// env.h
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>.</span><span class=o>/</span><span class=n>include</span><span class=o>/</span><span class=n>env</span><span class=p>.</span><span class=nl>h</span><span class=p>:</span><span class=mi>11</span><span class=o>:</span><span class=err>#</span><span class=n>define</span> <span class=n>LOG2NENV</span>     <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=o>/</span><span class=n>include</span><span class=o>/</span><span class=n>env</span><span class=p>.</span><span class=nl>h</span><span class=p>:</span><span class=mi>12</span><span class=o>:</span><span class=err>#</span><span class=n>define</span> <span class=n>NENV</span>         <span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=n>LOG2NENV</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=o>/</span><span class=n>include</span><span class=o>/</span><span class=n>env</span><span class=p>.</span><span class=nl>h</span><span class=p>:</span><span class=mi>13</span><span class=o>:</span><span class=err>#</span><span class=n>define</span> <span class=n>ENVX</span><span class=p>(</span><span class=n>envid</span><span class=p>)</span>  <span class=p>((</span><span class=n>envid</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>NENV</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=c1>// env.c
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=n>Env</span> <span class=o>*</span><span class=n>envs</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>        <span class=c1>// All environments
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=n>Env</span> <span class=o>*</span><span class=n>curenv</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>            <span class=c1>// the current env
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>Env_list</span> <span class=n>env_free_list</span><span class=p>;</span>    <span class=c1>// Free list
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=n>Env_list</span> <span class=n>env_sched_list</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>      <span class=c1>// Runnable list
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=n>Pde</span> <span class=o>*</span><span class=n>boot_pgdir</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=kt>char</span> <span class=o>*</span><span class=n>KERNEL_SP</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>u_int</span> <span class=n>asid_bitmap</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span> <span class=c1>// 64
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// mmu.c
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>.</span><span class=o>/</span><span class=n>include</span><span class=o>/</span><span class=n>error</span><span class=p>.</span><span class=nl>h</span><span class=p>:</span><span class=mi>8</span><span class=o>:</span><span class=err>#</span><span class=n>define</span> <span class=n>E_BAD_ENV</span>       <span class=mi>2</span>       <span class=c1>// Environment doesn&#39;t exist or otherwise
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>.</span><span class=o>/</span><span class=n>include</span><span class=o>/</span><span class=n>mmu</span><span class=p>.</span><span class=nl>h</span><span class=p>:</span><span class=mi>109</span><span class=o>:</span><span class=err>#</span><span class=n>define</span> <span class=n>E_BAD_ENV</span>       <span class=mi>2</span>       <span class=c1>// Environment doesn&#39;t exist or otherwise
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// pageç›¸å…³
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define BY2PG		4096		</span><span class=c1>// bytes to a page
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PDMAP		(4*1024*1024)	</span><span class=c1>// bytes mapped by a page directory entry
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PGSHIFT		12
</span></span></span><span class=line><span class=cl><span class=cp>#define PDSHIFT		22		</span><span class=c1>// log2(PDMAP)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PDX(va)		((((u_long)(va))&gt;&gt;22) &amp; 0x03FF) </span><span class=c1>// å–é¡µç›®å½•åºå·
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PTX(va)		((((u_long)(va))&gt;&gt;12) &amp; 0x03FF) </span><span class=c1>// å–...åºå·
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PTE_ADDR(pte)	((u_long)(pte)&amp;~0xFFF)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// page number field of address
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PPN(va)		(((u_long)(va))&gt;&gt;12)
</span></span></span><span class=line><span class=cl><span class=cp>#define VPN(va)		PPN(va)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define VA2PFN(va)		(((u_long)(va)) &amp; 0xFFFFF000 ) </span><span class=c1>// va 2 PFN for EntryLo0/1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PTE2PT		1024
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// å†…å­˜åœ°å›¾
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define KERNBASE 0x80010000
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define VPT (ULIM + PDMAP )
</span></span></span><span class=line><span class=cl><span class=cp>#define KSTACKTOP (VPT-0x100)
</span></span></span><span class=line><span class=cl><span class=cp>#define KSTKSIZE (8*BY2PG)
</span></span></span><span class=line><span class=cl><span class=cp>#define ULIM 0x80000000	
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define UVPT (ULIM - PDMAP)
</span></span></span><span class=line><span class=cl><span class=cp>#define UPAGES (UVPT - PDMAP)
</span></span></span><span class=line><span class=cl><span class=cp>#define UENVS (UPAGES - PDMAP)
</span></span></span><span class=line><span class=cl><span class=cp>#define UTOP UENVS
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define UXSTACKTOP (UTOP)
</span></span></span><span class=line><span class=cl><span class=cp>#define TIMESTACK 0x82000000
</span></span></span><span class=line><span class=cl><span class=cp></span>    
</span></span><span class=line><span class=cl><span class=cp>#define PTE_ADDR(pte)        ((u_long)(pte)&amp;~0xFFF)
</span></span></span></code></pre></td></tr></table></div></div><p>0x00400000</p><h3 id=å˜é‡è½¬æ¢>å˜é‡è½¬æ¢<a hidden class=anchor aria-hidden=true href=#å˜é‡è½¬æ¢>#</a></h3><ul><li><code>page2ppn</code></li><li><code>page2pa</code></li><li><code>page2kva</code>ï¼šå°†é¡µè½¬æ¢ä¸ºå†…æ ¸çš„è™šæ‹Ÿåœ°å€</li><li><code>va2pa</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>LIST_HEAD</span><span class=p>(</span><span class=n>Page_list</span><span class=p>,</span> <span class=n>Page</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=nf>LIST_ENTRY</span><span class=p>(</span><span class=n>Page</span><span class=p>)</span> <span class=n>Page_LIST_entry_t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>Page</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>Page_LIST_entry_t</span> <span class=n>pp_link</span><span class=p>;</span>	<span class=cm>/* free list link */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Ref is the count of pointers (usually in page table entries)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// to this page.  This only holds for pages allocated using 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// page_alloc.  Pages allocated at boot time using pmap.c&#39;s &#34;alloc&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// do not have valid reference count fields.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=n>u_short</span> <span class=n>pp_ref</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=k>struct</span> <span class=n>Page</span> <span class=o>*</span><span class=n>pages</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=n>u_long</span>
</span></span><span class=line><span class=cl><span class=nf>page2ppn</span><span class=p>(</span><span class=k>struct</span> <span class=n>Page</span> <span class=o>*</span><span class=n>pp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>pp</span> <span class=o>-</span> <span class=n>pages</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=n>u_long</span>
</span></span><span class=line><span class=cl><span class=nf>page2pa</span><span class=p>(</span><span class=k>struct</span> <span class=n>Page</span> <span class=o>*</span><span class=n>pp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>page2ppn</span><span class=p>(</span><span class=n>pp</span><span class=p>)</span><span class=o>&lt;&lt;</span><span class=n>PGSHIFT</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=k>struct</span> <span class=n>Page</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=nf>pa2page</span><span class=p>(</span><span class=n>u_long</span> <span class=n>pa</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>PPN</span><span class=p>(</span><span class=n>pa</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>npage</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>panic</span><span class=p>(</span><span class=s>&#34;pa2page called with invalid pa: %x&#34;</span><span class=p>,</span> <span class=n>pa</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=n>pages</span><span class=p>[</span><span class=n>PPN</span><span class=p>(</span><span class=n>pa</span><span class=p>)];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=n>u_long</span>
</span></span><span class=line><span class=cl><span class=nf>page2kva</span><span class=p>(</span><span class=k>struct</span> <span class=n>Page</span> <span class=o>*</span><span class=n>pp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>KADDR</span><span class=p>(</span><span class=n>page2pa</span><span class=p>(</span><span class=n>pp</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=n>u_long</span>
</span></span><span class=line><span class=cl><span class=nf>va2pa</span><span class=p>(</span><span class=n>Pde</span> <span class=o>*</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>u_long</span> <span class=n>va</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>Pte</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>pgdir</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>pgdir</span><span class=p>[</span><span class=n>PDX</span><span class=p>(</span><span class=n>va</span><span class=p>)];</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=o>*</span><span class=n>pgdir</span><span class=o>&amp;</span><span class=n>PTE_V</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>~</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>p</span> <span class=o>=</span> <span class=p>(</span><span class=n>Pte</span><span class=o>*</span><span class=p>)</span><span class=n>KADDR</span><span class=p>(</span><span class=n>PTE_ADDR</span><span class=p>(</span><span class=o>*</span><span class=n>pgdir</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>PTX</span><span class=p>(</span><span class=n>va</span><span class=p>)]</span><span class=o>&amp;</span><span class=n>PTE_V</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>~</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>PTE_ADDR</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>PTX</span><span class=p>(</span><span class=n>va</span><span class=p>)]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define ULIM 0x80000000
</span></span></span><span class=line><span class=cl><span class=cp>#define PADDR(kva)						\
</span></span></span><span class=line><span class=cl><span class=cp>({								\
</span></span></span><span class=line><span class=cl><span class=cp>	u_long a = (u_long) (kva);				\
</span></span></span><span class=line><span class=cl><span class=cp>	if (a &lt; ULIM)					\
</span></span></span><span class=line><span class=cl><span class=cp>		panic(&#34;PADDR called with invalid kva %08lx&#34;, a);\
</span></span></span><span class=line><span class=cl><span class=cp>	a - ULIM;						\
</span></span></span><span class=line><span class=cl><span class=cp>})
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// translates from physical address to kernel virtual address
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define KADDR(pa)						\
</span></span></span><span class=line><span class=cl><span class=cp>({								\
</span></span></span><span class=line><span class=cl><span class=cp>	u_long ppn = PPN(pa);					\
</span></span></span><span class=line><span class=cl><span class=cp>	if (ppn &gt;= npage)					\
</span></span></span><span class=line><span class=cl><span class=cp>		panic(&#34;KADDR called with invalid pa %08lx&#34;, (u_long)pa);\
</span></span></span><span class=line><span class=cl><span class=cp>	(pa) + ULIM;					\
</span></span></span><span class=line><span class=cl><span class=cp>})
</span></span></span></code></pre></td></tr></table></div></div><h2 id=exercise>Exercise<a hidden class=anchor aria-hidden=true href=#exercise>#</a></h2><h3 id=exercise-31>exercise 3.1<a hidden class=anchor aria-hidden=true href=#exercise-31>#</a></h3><ul><li>ä½¿ç”¨<code>boot_map_segment</code>è¿›è¡Œæ®µæ˜ å°„ï¼Œenvs æ•°ç»„åº”è¯¥è¢«UENVS åŒºåŸŸæ˜ å°„</li></ul><h3 id=exercise-32>exercise 3.2<a hidden class=anchor aria-hidden=true href=#exercise-32>#</a></h3><ul><li>ä½¿ç”¨<code>envs</code>å‡½æ•°ï¼Œæ³¨æ„<code>queue.h</code>å‡½æ•°è°ƒç”¨çš„å‚æ•°ç±»å‹ã€‚</li><li>æ’å…¥é¡ºåºä¸ºå€’åº</li></ul><h3 id=exercise-33>exercise 3.3<a hidden class=anchor aria-hidden=true href=#exercise-33>#</a></h3><h4 id=å…³äºasid_allocå‡½æ•°>å…³äº<code>asid_alloc</code>å‡½æ•°<a hidden class=anchor aria-hidden=true href=#å…³äºasid_allocå‡½æ•°>#</a></h4><p>asid_alloc å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯ä¸ºæ–°åˆ›å»ºçš„è¿›ç¨‹åˆ†é…ä¸€ä¸ªå¼‚äºå½“å‰æ‰€æœ‰æœªè¢«é‡Šæ”¾çš„è¿›ç¨‹çš„ ASIDã€‚</p><ul><li><p>è¿™ä¸ª ASIDæ˜¯ä»€ä¹ˆï¼Ÿ</p></li><li><p>ä¸ºä»€ä¹ˆè¦ä¸å…¶ä»–çš„è¿›ç¨‹ä¸åŒå‘¢ï¼Ÿ</p></li></ul><p>æ ¹æ® lab2 çš„å­¦ä¹ æˆ‘ä»¬å¾—çŸ¥è¿›ç¨‹æ˜¯é€šè¿‡é¡µè¡¨æ¥è®¿é—®å†…å­˜çš„ï¼Œè€Œä¸åŒçš„è¿›ç¨‹çš„åŒä¸€ä¸ªè™šæ‹Ÿåœ°å€å¯èƒ½ä¼šæ˜ å°„åˆ°ä¸åŒçš„ç‰©ç†åœ°å€ã€‚</p><p>ä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ï¼ŒTLB ä¸­é™¤äº†å­˜å‚¨é¡µè¡¨çš„æ˜ å°„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜ä¼šå­˜å‚¨è¿›ç¨‹çš„æ ‡è¯†ç¼–å·ï¼Œä½œä¸º Key çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºä¿è¯æŸ¥åˆ°çš„é¡µé¢æ˜ å°„å±äºå½“å‰è¿›ç¨‹ï¼Œè€Œè¿™ä¸ªç¼–å·å°±æ˜¯ASIDã€‚æ˜¾ç„¶ï¼Œä¸åŒè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€æ˜¯å¯ä»¥å¯¹åº”ç›¸åŒ VPN çš„ï¼Œè€Œå¦‚æœ ASID ä¹Ÿä¸å…·å¤‡å”¯ä¸€æ ‡è¯†æ€§ï¼Œå°±ä¸ TLB Field çš„å”¯ä¸€æ€§è¦æ±‚ç›¸çŸ›ç›¾äº†ã€‚å› æ­¤ï¼Œç›´åˆ°è¿›ç¨‹è¢«é”€æ¯æˆ– TLB è¢«æ¸…ç©ºæ—¶ï¼Œæ‰å¯ä»¥æŠŠè¿™ä¸ª ASID åˆ†é…ç»™å…¶ä»–è¿›ç¨‹ã€‚</p><ul><li>ä¸ºä»€ä¹ˆä¸èƒ½ç®€å•çš„é€šè¿‡è‡ªå¢æ¥é¿å…å†²çªå‘¢ï¼Ÿ</li></ul><p>ç®€å•çš„å›ç­”ï¼šç”¨æ¥å­˜å‚¨ASIDçš„ä½æ•°æœ‰é™ï¼Œè‡ªå¢å®¹æ˜“å‘ç”Ÿæº¢å‡º</p><p><img loading=lazy src=../%e6%96%87%e6%a1%a3.assets/image-20220427171313108.png alt=image-20220427171313108></p><h3 id=exercise-34-env_setup_vm>exercise 3.4 <code>env_setup_vm</code><a hidden class=anchor aria-hidden=true href=#exercise-34-env_setup_vm>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>env_setup_vm</span><span class=p>(</span><span class=k>struct</span> <span class=n>Env</span> <span class=o>*</span><span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>PDX</span><span class=p>(</span><span class=n>UTOP</span><span class=p>);</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=n>pgdir</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=n>PDX</span><span class=p>(</span><span class=n>UTOP</span><span class=p>);</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>PTE2PT</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>!=</span> <span class=n>PDX</span><span class=p>(</span><span class=n>VPT</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>i</span> <span class=o>!=</span> <span class=n>PDX</span><span class=p>(</span><span class=n>UVPT</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>pgdir</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>boot_pgdir</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>å¾ˆå¤šç–‘é—®</li><li>å…³äº<code>boot_pgdir</code></li></ul><h3 id=exercise-35-env_alloc>exercise 3.5 <code>env_alloc</code><a hidden class=anchor aria-hidden=true href=#exercise-35-env_alloc>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// è®¾ç½®spå¯„å­˜å™¨
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>e</span><span class=o>-&gt;</span><span class=n>env_tf</span><span class=p>.</span><span class=n>regs</span><span class=p>[</span><span class=mi>29</span><span class=p>]</span> <span class=o>=</span> <span class=n>USTACKTOP</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=exercise-36-load_icode_mapper>exercise 3.6 <code>load_icode_mapper </code><a hidden class=anchor aria-hidden=true href=#exercise-36-load_icode_mapper>#</a></h3><p>è°ƒç”¨é“¾ï¼š<code>load_icode -> load_elf -> load_icode_mapper</code></p><h3 id=exercise-37-load_elfå’Œload_icode>exercise 3.7 <code>load_elf</code>å’Œ<code>load_icode</code><a hidden class=anchor aria-hidden=true href=#exercise-37-load_elfå’Œload_icode>#</a></h3><h3 id=exercise-38-env_create-å’Œenv_create_priority>exercise 3.8 <code>env_create </code>å’Œ<code>env_create_priority</code><a hidden class=anchor aria-hidden=true href=#exercise-38-env_create-å’Œenv_create_priority>#</a></h3><p>è°ƒç”¨é“¾ï¼š<code>env_create -> env_create_priority</code></p><h3 id=exercise-39-mips_init>exercise 3.9 <code>mips_init</code><a hidden class=anchor aria-hidden=true href=#exercise-39-mips_init>#</a></h3><h3 id=exercise-310-env_run>exercise 3.10 <code>env_run</code><a hidden class=anchor aria-hidden=true href=#exercise-310-env_run>#</a></h3><h3 id=exercise-311-page_init>exercise 3.11 <code>page_init</code><a hidden class=anchor aria-hidden=true href=#exercise-311-page_init>#</a></h3><h2 id=thinking>Thinking<a hidden class=anchor aria-hidden=true href=#thinking>#</a></h2><h3 id=thinking-31>Thinking 3.1<a hidden class=anchor aria-hidden=true href=#thinking-31>#</a></h3><p>æ€è€ƒenvid2env å‡½æ•°:</p><p>ä¸ºä»€ä¹ˆenvid2env ä¸­éœ€è¦åˆ¤æ–­e->env_id != envid çš„æƒ…å†µï¼Ÿå¦‚æœæ²¡æœ‰è¿™æ­¥åˆ¤æ–­ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿ</p><ul><li>envidå¯èƒ½å¤§äº64</li><li>æ²¡æœ‰è¿™ä¸€æ­¥å¯èƒ½å¯¼è‡´éå†…å­˜æ§åˆ¶å¿«çš„å†…å­˜åœ°å€è¢«è½¬æ¢</li></ul><h3 id=thinking-32>Thinking 3.2<a hidden class=anchor aria-hidden=true href=#thinking-32>#</a></h3><p>ç»“åˆinclude/mmu.h ä¸­çš„åœ°å€ç©ºé—´å¸ƒå±€ï¼Œæ€è€ƒenv_setup_vm å‡½æ•°ï¼š</p><ul><li>UTOP å’ŒULIM çš„å«ä¹‰åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼ŒUTOP å’ŒULIM ä¹‹é—´çš„åŒºåŸŸä¸UTOPä»¥ä¸‹çš„åŒºåŸŸç›¸æ¯”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li></ul><ol><li>ULIMä»¥ä¸Šæ˜¯å†…æ ¸æ€</li><li>UTOPä¸ULIMä¹‹é—´æœ‰ä¸‰ä¸ªé¡µè¡¨</li><li>ULIMä¹‹ä¸‹çš„æ˜¯æ ˆï¼ŒUTOPå’ŒULIMä¹‹é—´çš„åŒºåŸŸæ˜¯é¡µè¡¨</li></ol><ul><li>è¯·ç»“åˆç³»ç»Ÿè‡ªæ˜ å°„æœºåˆ¶è§£é‡Šä»£ç ä¸­pgdir[PDX(UVPT)]=env_cr3çš„å«ä¹‰ã€‚</li></ul><p>è‡ªèº«æ˜ å°„åˆ°è‡ªèº«</p><ul><li>è°ˆè°ˆè‡ªå·±å¯¹è¿›ç¨‹ä¸­ç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€çš„ç†è§£ã€‚</li></ul><p>ä¹‹é—´æœ‰æ˜ å°„å…³ç³»ã€‚</p><h3 id=thinking-33>Thinking 3.3<a hidden class=anchor aria-hidden=true href=#thinking-33>#</a></h3><p>æ‰¾åˆ° user_data è¿™ä¸€å‚æ•°çš„æ¥æºï¼Œæ€è€ƒå®ƒçš„ä½œç”¨ã€‚æ²¡æœ‰è¿™ä¸ªå‚æ•°å¯ä¸å¯ä»¥ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿï¼ˆå¯ä»¥å°è¯•è¯´æ˜å®é™…çš„åº”ç”¨åœºæ™¯ï¼Œä¸¾ä¸€ä¸ªå®é™…çš„åº“ä¸­çš„ä¾‹å­ï¼‰</p><ul><li>ä¸ºload_icode_mapperä¼ å‚</li></ul><h3 id=thinking-34>Thinking 3.4<a hidden class=anchor aria-hidden=true href=#thinking-34>#</a></h3><p>ç»“åˆload_icode_mapper çš„å‚æ•°ä»¥åŠäºŒè¿›åˆ¶é•œåƒçš„å¤§å°ï¼Œè€ƒè™‘è¯¥å‡½æ•°å¯èƒ½ä¼šé¢ä¸´å“ªå‡ ç§å¤åˆ¶çš„æƒ…å†µï¼Ÿä½ æ˜¯å¦éƒ½è€ƒè™‘åˆ°äº†ï¼Ÿ</p><ul><li>vaä¸ä¸é¡µå¯¹å…¶</li><li>va+binsizeä¸ä¸é¡µé¢å¯¹é½</li></ul><h3 id=thinking-35>Thinking 3.5<a hidden class=anchor aria-hidden=true href=#thinking-35>#</a></h3><p>æ€è€ƒä¸Šé¢è¿™ä¸€æ®µè¯ï¼Œå¹¶æ ¹æ®è‡ªå·±åœ¨lab2 ä¸­çš„ç†è§£ï¼Œå›ç­”ï¼š</p><ul><li>ä½ è®¤ä¸ºè¿™é‡Œçš„ env_tf.pc å­˜å‚¨çš„æ˜¯ç‰©ç†åœ°å€è¿˜æ˜¯è™šæ‹Ÿåœ°å€?</li></ul><p>æ˜¯è™šæ‹Ÿåœ°å€</p><ul><li>ä½ è§‰å¾—entry_pointå…¶å€¼å¯¹äºæ¯ä¸ªè¿›ç¨‹æ˜¯å¦ä¸€æ ·ï¼Ÿè¯¥å¦‚ä½•ç†è§£è¿™ç§ç»Ÿä¸€æˆ–ä¸åŒ</li></ul><p>ä¸ä¸€å®šç›¸åŒï¼Œå¯¹ä¸åŒçš„elfæ–‡ä»¶entry_pointä¸åŒã€‚</p><h3 id=thinking-36>Thinking 3.6<a hidden class=anchor aria-hidden=true href=#thinking-36>#</a></h3><p>è¯·æŸ¥é˜…ç›¸å…³èµ„æ–™è§£é‡Šï¼Œä¸Šé¢æåˆ°çš„epcæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦å°†env_tf.pcè®¾ç½®ä¸ºepcå‘¢ï¼Ÿ</p><h3 id=thinking-37>Thinking 3.7<a hidden class=anchor aria-hidden=true href=#thinking-37>#</a></h3><p>å…³äº TIMESTACKï¼Œè¯·æ€è€ƒä»¥ä¸‹é—®é¢˜ï¼š</p><ul><li>æ“ä½œç³»ç»Ÿåœ¨ä½•æ—¶å°†ä»€ä¹ˆå†…å®¹å­˜åˆ°äº† TIMESTACK åŒºåŸŸ</li><li>TIMESTACK å’Œ env_asm.S ä¸­æ‰€å®šä¹‰çš„ KERNEL_SP çš„å«ä¹‰æœ‰ä½•ä¸åŒ</li></ul><h3 id=thinking-38>Thinking 3.8<a hidden class=anchor aria-hidden=true href=#thinking-38>#</a></h3><p>è¯•æ‰¾å‡ºä¸Šè¿° 5 ä¸ªå¼‚å¸¸å¤„ç†å‡½æ•°çš„å…·ä½“å®ç°ä½ç½®ã€‚</p><table><thead><tr><th>å¼‚å¸¸å·</th><th>å¤„ç†å‡½æ•°</th><th>å«ä¹‰</th><th>å…·ä½“å®ç°ä½ç½®</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>0</td><td>handle_int</td><td>è¡¨ç¤ºä¸­æ–­ï¼Œç”±æ—¶é’Ÿä¸­æ–­ã€æ§åˆ¶å°ä¸­æ–­ç­‰ä¸­æ–­é€ æˆ</td><td>./lib/genex.S</td><td></td></tr><tr><td>1</td><td>handle_mod</td><td>è¡¨ç¤ºå­˜å‚¨å¼‚å¸¸ï¼Œè¿›è¡Œå­˜å‚¨æ“ä½œæ—¶è¯¥é¡µè¢«æ ‡è®°ä¸ºåªè¯»</td><td>./lib/genex.S</td><td></td></tr><tr><td>2</td><td>handle_tlb</td><td>TLB å¼‚å¸¸ï¼ŒTLB ä¸­æ²¡æœ‰å’Œç¨‹åºåœ°å€åŒ¹é…çš„æœ‰æ•ˆå…¥å£</td><td>./lib/genex.S</td><td></td></tr><tr><td>3</td><td>handle_tlb</td><td>TLB å¼‚å¸¸ï¼ŒTLB å¤±æ•ˆï¼Œä¸”æœªå¤„äºå¼‚å¸¸æ¨¡å¼ï¼ˆç”¨äºæé«˜å¤„ç†æ•ˆç‡ï¼‰</td><td>./lib/genex.S</td><td></td></tr><tr><td>8</td><td>handle_sys</td><td>ç³»ç»Ÿè°ƒç”¨ï¼Œé™·å…¥å†…æ ¸ï¼Œæ‰§è¡Œäº† syscall æŒ‡ä»¤</td><td>./lib/syscall.S</td><td></td></tr></tbody></table><h3 id=thinking-39>Thinking 3.9<a hidden class=anchor aria-hidden=true href=#thinking-39>#</a></h3><p>é˜…è¯» kclock_asm.S å’Œ genex.S ä¸¤ä¸ªæ–‡ä»¶ï¼Œå¹¶å°è¯•è¯´å‡º set_timer å’Œtimer_irq å‡½æ•°ä¸­æ¯è¡Œæ±‡ç¼–ä»£ç çš„ä½œç”¨</p><h4 id=set_timer>set_timer<a hidden class=anchor aria-hidden=true href=#set_timer>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>LEAF(set_timer)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	li t0, 0xc8
</span></span><span class=line><span class=cl>	sb t0, 0xb5000100	// å‘0xb5000100 ä½ç½®å†™å…¥0xc8
</span></span><span class=line><span class=cl>	sw	sp, KERNEL_SP	// å°†å½“å‰æ ˆæŒ‡é’ˆä¿å­˜åˆ°KERNEL_SP
</span></span><span class=line><span class=cl>	setup_c0_status STATUS_CU0|0x1001 0	// è°ƒç”¨setup_c0_statuså‡½æ•°
</span></span><span class=line><span class=cl>	jr ra
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	nop
</span></span><span class=line><span class=cl>END(set_timer)
</span></span></code></pre></td></tr></table></div></div><h4 id=time_irq>time_irq<a hidden class=anchor aria-hidden=true href=#time_irq>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>timer_irq:
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	sb zero, 0xb5000110	// åœ¨0xb5000110å†™å…¥0
</span></span><span class=line><span class=cl>1:	j	sched_yield		// è·³è½¬åˆ°sched_ yield 
</span></span><span class=line><span class=cl>	nop
</span></span><span class=line><span class=cl>	/*li t1, 0xff
</span></span><span class=line><span class=cl>	lw    t0, delay
</span></span><span class=line><span class=cl>	addu  t0, 1
</span></span><span class=line><span class=cl>	sw	t0, delay
</span></span><span class=line><span class=cl>	beq	t0,t1,1f	
</span></span><span class=line><span class=cl>	nop*/
</span></span><span class=line><span class=cl>	j	ret_from_exception	
</span></span><span class=line><span class=cl>	nop
</span></span></code></pre></td></tr></table></div></div><p>è¦äº§ç”Ÿæ—¶é’Ÿä¸­æ–­ï¼Œæˆ‘ä»¬ä¸ä»…è¦äº†è§£ä¸­æ–­çš„äº§ç”Ÿä¸å¤„ç†ï¼Œè¿˜è¦äº†è§£ gxemul æ˜¯å¦‚ä½•æ¨¡æ‹Ÿæ—¶é’Ÿä¸­æ–­çš„ã€‚kclock_init å‡½æ•°å®Œæˆäº†æ—¶é’Ÿçš„åˆå§‹åŒ–ï¼Œè¯¥å‡½æ•°ä¸»è¦è°ƒç”¨ set_timer å‡½æ•°ï¼Œå®Œæˆå¦‚ä¸‹æ“ä½œï¼š</p><ul><li>é¦–å…ˆå‘0xb5000100 ä½ç½®å†™å…¥0xc8ï¼Œå…¶ä¸­0xb5000000 æ˜¯æ¨¡æ‹Ÿå™¨(gxemul) æ˜ å°„å®æ—¶é’Ÿçš„ä½ç½®ã€‚åç§»é‡ä¸º0x100 è¡¨ç¤ºæ¥è®¾ç½®å®æ—¶é’Ÿä¸­æ–­çš„é¢‘ç‡ï¼Œ0xc8 åˆ™è¡¨ç¤º1 ç§’é’Ÿä¸­æ–­200æ¬¡ï¼Œå¦‚æœå†™å…¥0ï¼Œè¡¨ç¤ºå…³é—­å®æ—¶é’Ÿã€‚å®æ—¶é’Ÿå¯¹äºR3000 æ¥è¯´ç»‘å®šåˆ°äº†4 å·ä¸­æ–­ä¸Šï¼Œæ•…è¿™æ®µä»£ç å…¶å®ä¸»è¦ç”¨æ¥è§¦å‘äº†4 å·ä¸­æ–­ã€‚æ³¨æ„è¿™é‡Œçš„ä¸­æ–­å·å’Œå¼‚å¸¸å·æ˜¯ä¸ä¸€æ ·çš„æ¦‚å¿µï¼Œæˆ‘ä»¬å®éªŒçš„å¼‚å¸¸åŒ…æ‹¬ä¸­æ–­ã€‚</li><li>ä¸€æ—¦å®æ—¶é’Ÿä¸­æ–­äº§ç”Ÿï¼Œå°±ä¼šè§¦å‘MIPS ä¸­æ–­ï¼Œä»è€ŒMIPS å°†PC æŒ‡å‘0x80000080ï¼Œä»è€Œè·³è½¬åˆ°.text.exc_vec3ä»£ç æ®µæ‰§è¡Œã€‚å¯¹äºå®æ—¶é’Ÿå¼•èµ·çš„ä¸­æ–­ï¼Œé€šè¿‡.text.exc_vec3ä»£ç æ®µçš„åˆ†å‘ï¼Œæœ€ç»ˆä¼šè°ƒç”¨handle_ int å‡½æ•°æ¥å¤„ç†å®æ—¶é’Ÿä¸­æ–­ã€‚</li><li>åœ¨handle_ int åˆ¤æ–­CP0_CAUSEå¯„å­˜å™¨æ˜¯ä¸æ˜¯å¯¹åº”çš„4 å·ä¸­æ–­ä½å¼•å‘çš„ä¸­æ–­ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ‰§è¡Œä¸­æ–­æœåŠ¡å‡½æ•°timer_ irqã€‚</li><li>åœ¨timer_ irq é‡Œç›´æ¥è·³è½¬åˆ°sched_ yield ä¸­æ‰§è¡Œã€‚è€Œè¿™ä¸ªå‡½æ•°å°±æ˜¯æˆ‘ä»¬å°†è¦è¡¥å……çš„è°ƒåº¦å‡½æ•°ã€‚</li></ul><h4 id=save_all>SAVE_ALL<a hidden class=anchor aria-hidden=true href=#save_all>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>.macro SAVE_ALL
</span></span><span class=line><span class=cl>		// å‰å››è¡Œå…¶é¦–å…ˆå–å‡ºäº† SR å¯„å­˜å™¨çš„å€¼, ç„¶ååˆ©ç”¨ç§»ä½ç­‰æ“ä½œåˆ¤æ–­ç¬¬ 28 ä½çš„å€¼, æ ¹æ®å‰é¢çš„è®²è¿°æˆ‘ä»¬å¯ä»¥çŸ¥é“, ä¹Ÿå³åˆ¤æ–­å½“å‰æ˜¯å¦å¤„äºç”¨æˆ·æ¨¡å¼ä¸‹ã€‚5
</span></span><span class=line><span class=cl>		mfc0	k0,CP0_STATUS
</span></span><span class=line><span class=cl>		sll		k0,3      /* extract cu0 bit */
</span></span><span class=line><span class=cl>		bltz	k0,1f
</span></span><span class=line><span class=cl>		nop
</span></span><span class=line><span class=cl>		/*
</span></span><span class=line><span class=cl>		 * Called from user mode, new stack
</span></span><span class=line><span class=cl>		 */
</span></span><span class=line><span class=cl>		// lui	k1,%hi(kernelsp)
</span></span><span class=line><span class=cl>		// lw	k1,%lo(kernelsp)(k1)  //not clear right now
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		// æ¥ä¸‹æ¥å°†å½“å‰è¿è¡Œæ ˆçš„åœ°å€ä¿å­˜åˆ° k0 ä¸­ï¼›ç„¶åè°ƒç”¨ get_sp å®ï¼Œæ ¹æ®ä¸­æ–­å¼‚å¸¸çš„ç§ç±»åˆ¤æ–­éœ€è¦ä¿å­˜çš„ä½ç½®ï¼Œå¹¶åˆ†é…ä¸€å®šçš„ç©ºé—´ï¼›å°†ä¹‹å‰çš„è¿è¡Œæ ˆåœ°å€ä¸ 2 å·å¯„å­˜å™¨ $v0 å…ˆä¿å­˜èµ·æ¥ï¼Œä¾¿äºåé¢å¯ä»¥æ”¾å¿ƒçš„ä½¿ç”¨ sp å¯„å­˜å™¨ä¸ v0 å¯„å­˜å™¨ã€‚
</span></span><span class=line><span class=cl>1:
</span></span><span class=line><span class=cl>		move	k0,sp
</span></span><span class=line><span class=cl>		get_sp
</span></span><span class=line><span class=cl>		move	k1,sp
</span></span><span class=line><span class=cl>		subu	sp,k1,TF_SIZE
</span></span><span class=line><span class=cl>		sw	k0,TF_REG29(sp)
</span></span><span class=line><span class=cl>		sw	$2,TF_REG2(sp)
</span></span><span class=line><span class=cl>		mfc0	v0,CP0_STATUS
</span></span><span class=line><span class=cl>		sw	v0,TF_STATUS(sp)
</span></span><span class=line><span class=cl>		mfc0	v0,CP0_CAUSE
</span></span><span class=line><span class=cl>		sw	v0,TF_CAUSE(sp)
</span></span><span class=line><span class=cl>		mfc0	v0,CP0_EPC
</span></span><span class=line><span class=cl>		sw	v0,TF_EPC(sp)
</span></span><span class=line><span class=cl>		mfc0	v0, CP0_BADVADDR
</span></span><span class=line><span class=cl>		sw	v0, TF_BADVADDR(sp)
</span></span><span class=line><span class=cl>		mfhi	v0
</span></span><span class=line><span class=cl>		sw	v0,TF_HI(sp)
</span></span><span class=line><span class=cl>		mflo	v0
</span></span><span class=line><span class=cl>		sw	v0,TF_LO(sp)
</span></span><span class=line><span class=cl>		sw	$0,TF_REG0(sp)
</span></span><span class=line><span class=cl>		sw	$1,TF_REG1(sp)
</span></span><span class=line><span class=cl>		//sw	$2,TF_REG2(sp)
</span></span><span class=line><span class=cl>		sw	$3,TF_REG3(sp)
</span></span><span class=line><span class=cl>		sw	$4,TF_REG4(sp)
</span></span><span class=line><span class=cl>		sw	$5,TF_REG5(sp)
</span></span><span class=line><span class=cl>		sw	$6,TF_REG6(sp)
</span></span><span class=line><span class=cl>		sw	$7,TF_REG7(sp)
</span></span><span class=line><span class=cl>		sw	$8,TF_REG8(sp)
</span></span><span class=line><span class=cl>		sw	$9,TF_REG9(sp)
</span></span><span class=line><span class=cl>		sw	$10,TF_REG10(sp)
</span></span><span class=line><span class=cl>		sw	$11,TF_REG11(sp)
</span></span><span class=line><span class=cl>		sw	$12,TF_REG12(sp)
</span></span><span class=line><span class=cl>		sw	$13,TF_REG13(sp)
</span></span><span class=line><span class=cl>		sw	$14,TF_REG14(sp)
</span></span><span class=line><span class=cl>		sw	$15,TF_REG15(sp)
</span></span><span class=line><span class=cl>		sw	$16,TF_REG16(sp)
</span></span><span class=line><span class=cl>		sw	$17,TF_REG17(sp)
</span></span><span class=line><span class=cl>		sw	$18,TF_REG18(sp)
</span></span><span class=line><span class=cl>		sw	$19,TF_REG19(sp)
</span></span><span class=line><span class=cl>		sw	$20,TF_REG20(sp)
</span></span><span class=line><span class=cl>		sw	$21,TF_REG21(sp)
</span></span><span class=line><span class=cl>		sw	$22,TF_REG22(sp)
</span></span><span class=line><span class=cl>		sw	$23,TF_REG23(sp)
</span></span><span class=line><span class=cl>		sw	$24,TF_REG24(sp)
</span></span><span class=line><span class=cl>		sw	$25,TF_REG25(sp)
</span></span><span class=line><span class=cl>		sw	$26,TF_REG26(sp) 
</span></span><span class=line><span class=cl>		sw	$27,TF_REG27(sp) 
</span></span><span class=line><span class=cl>		sw	$28,TF_REG28(sp)
</span></span><span class=line><span class=cl>		sw	$30,TF_REG30(sp)
</span></span><span class=line><span class=cl>		sw	$31,TF_REG31(sp)
</span></span><span class=line><span class=cl>.endm
</span></span></code></pre></td></tr></table></div></div><h2 id=å†…å­˜åœ°å›¾>å†…å­˜åœ°å›¾<a hidden class=anchor aria-hidden=true href=#å†…å­˜åœ°å›¾>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> o     4G -----------&gt;  +----------------------------+------------0x100000000
</span></span></span><span class=line><span class=cl><span class=cm> o                      |       ...                  |  kseg3
</span></span></span><span class=line><span class=cl><span class=cm> o                      +----------------------------+------------0xe000 0000
</span></span></span><span class=line><span class=cl><span class=cm> o                      |       ...                  |  kseg2
</span></span></span><span class=line><span class=cl><span class=cm> o                      +----------------------------+------------0xc000 0000
</span></span></span><span class=line><span class=cl><span class=cm> o                      |   Interrupts &amp; Exception   |  kseg1
</span></span></span><span class=line><span class=cl><span class=cm> o                      +----------------------------+------------0xa000 0000
</span></span></span><span class=line><span class=cl><span class=cm> o                      |      Invalid memory        |   /|\
</span></span></span><span class=line><span class=cl><span class=cm> o                      +----------------------------+----|-------Physics Memory Max
</span></span></span><span class=line><span class=cl><span class=cm> o                      |       ...                  |  kseg0
</span></span></span><span class=line><span class=cl><span class=cm> o  VPT,KSTACKTOP-----&gt; +----------------------------+----|-------0x8040 0000-------end
</span></span></span><span class=line><span class=cl><span class=cm> o                      |       Kernel Stack         |    | KSTKSIZE            /|\
</span></span></span><span class=line><span class=cl><span class=cm> o                      +----------------------------+----|------                |
</span></span></span><span class=line><span class=cl><span class=cm> o                      |       Kernel Text          |    |                    PDMAP
</span></span></span><span class=line><span class=cl><span class=cm> o      KERNBASE -----&gt; +----------------------------+----|-------0x8001 0000    | 
</span></span></span><span class=line><span class=cl><span class=cm> o                      |   Interrupts &amp; Exception   |   \|/                    \|/
</span></span></span><span class=line><span class=cl><span class=cm> o      ULIM     -----&gt; +----------------------------+------------0x8000 0000-------    
</span></span></span><span class=line><span class=cl><span class=cm> o                      |         User VPT           |     PDMAP                /|\ 
</span></span></span><span class=line><span class=cl><span class=cm> o      UVPT     -----&gt; +----------------------------+------------0x7fc0 0000    |
</span></span></span><span class=line><span class=cl><span class=cm> o                      |         PAGES              |     PDMAP                 |
</span></span></span><span class=line><span class=cl><span class=cm> o      UPAGES   -----&gt; +----------------------------+------------0x7f80 0000    |
</span></span></span><span class=line><span class=cl><span class=cm> o                      |         ENVS               |     PDMAP                 |
</span></span></span><span class=line><span class=cl><span class=cm> o  UTOP,UENVS   -----&gt; +----------------------------+------------0x7f40 0000    |
</span></span></span><span class=line><span class=cl><span class=cm> o  UXSTACKTOP -/       |     user exception stack   |     BY2PG               	   |
</span></span></span><span class=line><span class=cl><span class=cm> o                      +----------------------------+------------0x7f3f f000    |
</span></span></span><span class=line><span class=cl><span class=cm> o                      |       Invalid memory       |     BY2PG                 |
</span></span></span><span class=line><span class=cl><span class=cm> o      USTACKTOP ----&gt; +----------------------------+------------0x7f3f e000    |
</span></span></span><span class=line><span class=cl><span class=cm> o                      |     normal user stack      |     BY2PG                 |
</span></span></span><span class=line><span class=cl><span class=cm> o                      +----------------------------+------------0x7f3f d000    |
</span></span></span><span class=line><span class=cl><span class=cm> a                      |                            |                           |
</span></span></span><span class=line><span class=cl><span class=cm> a                      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                           |
</span></span></span><span class=line><span class=cl><span class=cm> a                      .                            .                           |
</span></span></span><span class=line><span class=cl><span class=cm> a                      .                            .                         kuseg
</span></span></span><span class=line><span class=cl><span class=cm> a                      .                            .                           |
</span></span></span><span class=line><span class=cl><span class=cm> a                      |~~~~~~~~~~~~~~~~~~~~~~~~~~~~|                           |
</span></span></span><span class=line><span class=cl><span class=cm> a                      |                            |                           |
</span></span></span><span class=line><span class=cl><span class=cm> o       UTEXT   -----&gt; +----------------------------+                           |
</span></span></span><span class=line><span class=cl><span class=cm> o                      |                            |     2 * PDMAP            \|/
</span></span></span><span class=line><span class=cl><span class=cm> a     0 ------------&gt;  +----------------------------+ -----------------------------
</span></span></span><span class=line><span class=cl><span class=cm> o
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>boot_pgdir è¢«æ˜ å°„åˆ°<code>UPAGES</code></li><li>envsè¢«æ˜ å°„åˆ°<code>UENVS</code></li></ul><p>04000000</p><h2 id=å¼‚å¸¸ä¸ä¸­æ–­>å¼‚å¸¸ä¸ä¸­æ–­<a hidden class=anchor aria-hidden=true href=#å¼‚å¸¸ä¸ä¸­æ–­>#</a></h2><p>æˆ‘ä»¬å®éªŒé‡Œè®¤ä¸ºå‡¡æ˜¯å¼•èµ·æ§åˆ¶æµçªå˜çš„éƒ½å«åšå¼‚å¸¸ï¼Œè€Œä¸­æ–­ä»…ä»…æ˜¯å¼‚å¸¸çš„ä¸€ç§ï¼Œå¹¶ä¸”æ˜¯ä»…æœ‰çš„ä¸€ç§å¼‚æ­¥å¼‚å¸¸ã€‚</p><h3 id=å¼‚å¸¸çš„äº§ç”Ÿä¸è¿”å›>å¼‚å¸¸çš„äº§ç”Ÿä¸è¿”å›<a hidden class=anchor aria-hidden=true href=#å¼‚å¸¸çš„äº§ç”Ÿä¸è¿”å›>#</a></h3><p><img loading=lazy src=https://os.buaa.edu.cn/assets/courseware/v1/bf6ba882116327e880dbcd654e1a779a/asset-v1:BUAA+B3I062270+2022_SPRING+type@asset+block/3-exception.png alt=å¼‚å¸¸å¤„ç†å›¾ç¤º></p></div><footer class=post-footer><ul class=post-tags><li><a href=http://appletea233.github.io/myblog_hogo/tags/study/>study</a></li><li><a href=http://appletea233.github.io/myblog_hogo/tags/os/>os</a></li></ul><nav class=paginav><a class=next href=http://appletea233.github.io/myblog_hogo/posts/blog/my-first-post/><span class=title>Next Page Â»</span><br><span>My First Post</span></a></nav></footer><div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>ğŸ’¬è¯„è®º</span><hr></div><div id=tcomment></div><script src=https://cdn.jsdelivr.net/npm/twikoo@1.5.9/dist/twikoo.all.min.js></script>
<script>twikoo.init({envId:"https://twikoo-12c9q2x4o-1530457905-qqcom.vercel.app/",el:"#tcomment",lang:"zh-CN",path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><span>&copy; 2022 <a href=http://appletea233.github.io/myblog_hogo>Appletea's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>