<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=robots content="index, follow"><title>BUAA操作系统lab3笔记 | Appletea's Blog</title><meta name=keywords content="study,os"><meta name=description content="如题"><meta name=author content="
作者:&nbsp;Appletea"><link rel=canonical href=http://appletea233.github.io/myblog_hogo/posts/blog/%E6%96%87%E6%A1%A3/><link crossorigin=anonymous href=/myblog_hogo/assets/css/stylesheet.min.dafbad219c160a2cdb650c1eb791a4a2416f32636655e6cfe0792b9e36128edc.css integrity="sha256-2vutIZwWCizbZQwet5GkokFvMmNmVebP4HkrnjYSjtw=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/myblog_hogo/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=http://appletea233.github.io/myblog_hogo/img/Q.jpg><link rel=icon type=image/png sizes=16x16 href=http://appletea233.github.io/myblog_hogo/img/Q.jpg><link rel=icon type=image/png sizes=32x32 href=http://appletea233.github.io/myblog_hogo/img/Q.jpg><link rel=apple-touch-icon href=http://appletea233.github.io/myblog_hogo/Q.jpg><link rel=mask-icon href=http://appletea233.github.io/myblog_hogo/Q.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="BUAA操作系统lab3笔记"><meta property="og:description" content="如题"><meta property="og:type" content="article"><meta property="og:url" content="http://appletea233.github.io/myblog_hogo/posts/blog/%E6%96%87%E6%A1%A3/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-08T17:43:03+08:00"><meta property="article:modified_time" content="2022-05-08T17:43:03+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="BUAA操作系统lab3笔记"><meta name=twitter:description content="如题"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"📚文章","item":"http://appletea233.github.io/myblog_hogo/posts/"},{"@type":"ListItem","position":3,"name":"Blog","item":"http://appletea233.github.io/myblog_hogo/posts/blog/"},{"@type":"ListItem","position":4,"name":"BUAA操作系统lab3笔记","item":"http://appletea233.github.io/myblog_hogo/posts/blog/%E6%96%87%E6%A1%A3/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"BUAA操作系统lab3笔记","name":"BUAA操作系统lab3笔记","description":"如题","keywords":["study","os"],"articleBody":"函数调用关系 结构体信息 Page 1 2 3 4 5 6 7 8 9  struct Page_list{ struct { struct { struct Page *le_next; struct Page le_prev; } pp_link; u_short pp_ref; }* lh_first; // Page* }    Env_list结构与之类似  Trapframe 1 2 3 4 5 6 7 8 9 10 11 12 13  struct Trapframe { //lr:need to be modified(reference to linux pt_regs) TODO \t/* Saved main processor registers. */ unsigned long regs[32]; /* Saved special registers. */ unsigned long cp0_status; unsigned long hi; unsigned long lo; unsigned long cp0_badvaddr; unsigned long cp0_cause; unsigned long cp0_epc; unsigned long pc; };   Env 1 2 3 4 5 6 7 8 9 10 11  struct Env { struct Trapframe env_tf; // Saved registers  LIST_ENTRY(Env) env_link; // Free LIST_ENTRY  u_int env_id; // Unique environment identifier  u_int env_parent_id; // env_id of this env's parent  u_int env_status; // Status of the environment  Pde *env_pgdir; // Kernel virtual address of page dir  u_int env_cr3; LIST_ENTRY(Env) env_sched_link; u_int env_pri; };    env_status : 该变量只能有以下三种取值：   ENV_FREE : 表明该进程是不活动的，即该进程控制块处于进程空闲链表中。 ENV_NOT_RUNNABLE : 表明该进程处于阻塞状态，处于该状态的进程需要在一定条件下变成就绪状态从而被CPU调度。（比如因进程通信阻塞时变为 ENV_NOT_RUNNABLE，收到信息后变回 ENV_RUNNABLE） ENV_RUNNABLE : 表明该进程处于执行状态或就绪状态，即其可能是正在运行的，也可能正在等待被调度。  Ehdr与Phdr 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  typedef struct { unsigned char\te_ident[EI_NIDENT];\t/* Magic number and other info */ Elf32_Half\te_type;\t/* Object file type */ Elf32_Half\te_machine;\t/* Architecture */ Elf32_Word\te_version;\t/* Object file version */ Elf32_Addr\te_entry;\t/* Entry point virtual address */ Elf32_Off\te_phoff;\t/* Program header table file offset */ Elf32_Off\te_shoff;\t/* Section header table file offset */ Elf32_Word\te_flags;\t/* Processor-specific flags */ Elf32_Half\te_ehsize;\t/* ELF header size in bytes */ Elf32_Half\te_phentsize;\t/* Program header table entry size */ Elf32_Half\te_phnum;\t/* Program header table entry count */ Elf32_Half\te_shentsize;\t/* Section header table entry size */ Elf32_Half\te_shnum;\t/* Section header table entry count */ Elf32_Half\te_shstrndx;\t/* Section header string table index */ } Elf32_Ehdr;   1 2 3 4 5 6 7 8 9 10  typedef struct { Elf32_Word\tp_type;\t/* Segment type */ Elf32_Off\tp_offset;\t/* Segment file offset */ Elf32_Addr\tp_vaddr;\t/* Segment virtual address */ Elf32_Addr\tp_paddr;\t/* Segment physical address */ Elf32_Word\tp_filesz;\t/* Segment size in file */ Elf32_Word\tp_memsz;\t/* Segment size in memory */ Elf32_Word\tp_flags;\t/* Segment flags */ Elf32_Word\tp_align;\t/* Segment alignment */ } Elf32_Phdr;   一些全局变量 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54  // env.h ./include/env.h:11:#define LOG2NENV 10 ./include/env.h:12:#define NENV (1LOG2NENV) ./include/env.h:13:#define ENVX(envid) ((envid) \u0026 (NENV - 1)) // env.c struct Env *envs = NULL; // All environments struct Env *curenv = NULL; // the current env  static struct Env_list env_free_list; // Free list struct Env_list env_sched_list[2]; // Runnable list  extern Pde *boot_pgdir; extern char *KERNEL_SP; static u_int asid_bitmap[2] = {0}; // 64  // mmu.c ./include/error.h:8:#define E_BAD_ENV 2 // Environment doesn't exist or otherwise ./include/mmu.h:109:#define E_BAD_ENV 2 // Environment doesn't exist or otherwise  // page相关 #define BY2PG\t4096\t// bytes to a page #define PDMAP\t(4*1024*1024)\t// bytes mapped by a page directory entry #define PGSHIFT\t12 #define PDSHIFT\t22\t// log2(PDMAP) #define PDX(va)\t((((u_long)(va))22) \u0026 0x03FF) // 取页目录序号 #define PTX(va)\t((((u_long)(va))12) \u0026 0x03FF) // 取...序号 #define PTE_ADDR(pte)\t((u_long)(pte)\u0026~0xFFF)  // page number field of address #define PPN(va)\t(((u_long)(va))12) #define VPN(va)\tPPN(va)  #define VA2PFN(va)\t(((u_long)(va)) \u0026 0xFFFFF000 ) // va 2 PFN for EntryLo0/1 #define PTE2PT\t1024  // 内存地图 #define KERNBASE 0x80010000  #define VPT (ULIM + PDMAP ) #define KSTACKTOP (VPT-0x100) #define KSTKSIZE (8*BY2PG) #define ULIM 0x80000000\t #define UVPT (ULIM - PDMAP) #define UPAGES (UVPT - PDMAP) #define UENVS (UPAGES - PDMAP) #define UTOP UENVS  #define UXSTACKTOP (UTOP) #define TIMESTACK 0x82000000  #define PTE_ADDR(pte) ((u_long)(pte)\u0026~0xFFF)   0x00400000\n变量转换  page2ppn page2pa page2kva：将页转换为内核的虚拟地址 va2pa  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55  LIST_HEAD(Page_list, Page); typedef LIST_ENTRY(Page) Page_LIST_entry_t; struct Page { Page_LIST_entry_t pp_link;\t/* free list link */ // Ref is the count of pointers (usually in page table entries) \t// to this page. This only holds for pages allocated using \t// page_alloc. Pages allocated at boot time using pmap.c's \"alloc\" \t// do not have valid reference count fields.  u_short pp_ref; }; extern struct Page *pages; static inline u_long page2ppn(struct Page *pp) { return pp - pages; } static inline u_long page2pa(struct Page *pp) { return page2ppn(pp)PGSHIFT; } static inline struct Page * pa2page(u_long pa) { if (PPN(pa) = npage) panic(\"pa2page called with invalid pa: %x\", pa); return \u0026pages[PPN(pa)]; } static inline u_long page2kva(struct Page *pp) { return KADDR(page2pa(pp)); } static inline u_long va2pa(Pde *pgdir, u_long va) { Pte *p; pgdir = \u0026pgdir[PDX(va)]; if (!(*pgdir\u0026PTE_V)) return ~0; p = (Pte*)KADDR(PTE_ADDR(*pgdir)); if (!(p[PTX(va)]\u0026PTE_V)) return ~0; return PTE_ADDR(p[PTX(va)]); }   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  #define ULIM 0x80000000 #define PADDR(kva)\t\\ ({\t\\ u_long a = (u_long) (kva);\t\\ if (a panic(\"PADDR called with invalid kva %08lx\", a);\\ a - ULIM;\t\\ })  // translates from physical address to kernel virtual address #define KADDR(pa)\t\\ ({\t\\ u_long ppn = PPN(pa);\t\\ if (ppn = npage)\t\\ panic(\"KADDR called with invalid pa %08lx\", (u_long)pa);\\ (pa) + ULIM;\t\\ })   Exercise exercise 3.1  使用boot_map_segment进行段映射，envs 数组应该被UENVS 区域映射  exercise 3.2  使用envs函数，注意queue.h函数调用的参数类型。 插入顺序为倒序  exercise 3.3 关于asid_alloc函数 asid_alloc 函数，这个函数的作用是为新创建的进程分配一个异于当前所有未被释放的进程的 ASID。\n  这个 ASID是什么？\n  为什么要与其他的进程不同呢？\n  根据 lab2 的学习我们得知进程是通过页表来访问内存的，而不同的进程的同一个虚拟地址可能会映射到不同的物理地址。\n为了实现这个功能，TLB 中除了存储页表的映射信息之外，还会存储进程的标识编号，作为 Key 的一部分，用于保证查到的页面映射属于当前进程，而这个编号就是ASID。显然，不同进程的虚拟地址是可以对应相同 VPN 的，而如果 ASID 也不具备唯一标识性，就与 TLB Field 的唯一性要求相矛盾了。因此，直到进程被销毁或 TLB 被清空时，才可以把这个 ASID 分配给其他进程。\n 为什么不能简单的通过自增来避免冲突呢？  简单的回答：用来存储ASID的位数有限，自增容易发生溢出\nexercise 3.4 env_setup_vm 1 2 3 4 5 6 7 8 9  static int env_setup_vm(struct Env *e); for (i = 0; i  PDX(UTOP); i++){ pgdir[i] = 0; } for (i = PDX(UTOP); iPTE2PT; i++){ if (i != PDX(VPT) \u0026\u0026 i != PDX(UVPT)) pgdir[i] = boot_pgdir[i]; }    很多疑问 关于boot_pgdir  exercise 3.5 env_alloc 1 2  // 设置sp寄存器 e-env_tf.regs[29] = USTACKTOP;   exercise 3.6 load_icode_mapper\t 调用链：load_icode - load_elf - load_icode_mapper\nexercise 3.7 load_elf和load_icode exercise 3.8 env_create 和env_create_priority 调用链：env_create - env_create_priority\nexercise 3.9 mips_init exercise 3.10 env_run exercise 3.11 page_init Thinking Thinking 3.1 思考envid2env 函数:\n为什么envid2env 中需要判断e-env_id != envid 的情况？如果没有这步判断会发生什么情况？\n envid可能大于64 没有这一步可能导致非内存控制快的内存地址被转换  Thinking 3.2 结合include/mmu.h 中的地址空间布局，思考env_setup_vm 函数：\n UTOP 和ULIM 的含义分别是什么，UTOP 和ULIM 之间的区域与UTOP以下的区域相比有什么区别？   ULIM以上是内核态 UTOP与ULIM之间有三个页表 ULIM之下的是栈，UTOP和ULIM之间的区域是页表   请结合系统自映射机制解释代码中pgdir[PDX(UVPT)]=env_cr3的含义。  自身映射到自身\n 谈谈自己对进程中物理地址和虚拟地址的理解。  之间有映射关系。\nThinking 3.3 找到 user_data 这一参数的来源，思考它的作用。没有这个参数可不可以？为什么？（可以尝试说明实际的应用场景，举一个实际的库中的例子）\n 为load_icode_mapper传参  Thinking 3.4 结合load_icode_mapper 的参数以及二进制镜像的大小，考虑该函数可能会面临哪几种复制的情况？你是否都考虑到了？\n va不与页对其 va+binsize不与页面对齐  Thinking 3.5 思考上面这一段话，并根据自己在lab2 中的理解，回答：\n 你认为这里的 env_tf.pc 存储的是物理地址还是虚拟地址?  是虚拟地址\n 你觉得entry_point其值对于每个进程是否一样？该如何理解这种统一或不同  不一定相同，对不同的elf文件entry_point不同。\nThinking 3.6 请查阅相关资料解释，上面提到的epc是什么？为什么要将env_tf.pc设置为epc呢？\nThinking 3.7 关于 TIMESTACK，请思考以下问题：\n 操作系统在何时将什么内容存到了 TIMESTACK 区域 TIMESTACK 和 env_asm.S 中所定义的 KERNEL_SP 的含义有何不同  Thinking 3.8 试找出上述 5 个异常处理函数的具体实现位置。\n   异常号 处理函数 含义 具体实现位置 备注     0 handle_int 表示中断，由时钟中断、控制台中断等中断造成 ./lib/genex.S    1 handle_mod 表示存储异常，进行存储操作时该页被标记为只读 ./lib/genex.S    2 handle_tlb TLB 异常，TLB 中没有和程序地址匹配的有效入口 ./lib/genex.S    3 handle_tlb TLB 异常，TLB 失效，且未处于异常模式（用于提高处理效率） ./lib/genex.S    8 handle_sys 系统调用，陷入内核，执行了 syscall 指令 ./lib/syscall.S     Thinking 3.9 阅读 kclock_asm.S 和 genex.S 两个文件，并尝试说出 set_timer 和timer_irq 函数中每行汇编代码的作用\nset_timer 1 2 3 4 5 6 7 8 9 10  LEAF(set_timer) li t0, 0xc8 sb t0, 0xb5000100\t// 向0xb5000100 位置写入0xc8 sw\tsp, KERNEL_SP\t// 将当前栈指针保存到KERNEL_SP setup_c0_status STATUS_CU0|0x1001 0\t// 调用setup_c0_status函数 jr ra nop END(set_timer)   time_irq 1 2 3 4 5 6 7 8 9 10 11 12 13  timer_irq: sb zero, 0xb5000110\t// 在0xb5000110写入0 1:\tj\tsched_yield\t// 跳转到sched_ yield nop /*li t1, 0xff lw t0, delay addu t0, 1 sw\tt0, delay beq\tt0,t1,1f\tnop*/ j\tret_from_exception\tnop   要产生时钟中断，我们不仅要了解中断的产生与处理，还要了解 gxemul 是如何模拟时钟中断的。kclock_init 函数完成了时钟的初始化，该函数主要调用 set_timer 函数，完成如下操作：\n 首先向0xb5000100 位置写入0xc8，其中0xb5000000 是模拟器(gxemul) 映射实时钟的位置。偏移量为0x100 表示来设置实时钟中断的频率，0xc8 则表示1 秒钟中断200次，如果写入0，表示关闭实时钟。实时钟对于R3000 来说绑定到了4 号中断上，故这段代码其实主要用来触发了4 号中断。注意这里的中断号和异常号是不一样的概念，我们实验的异常包括中断。 一旦实时钟中断产生，就会触发MIPS 中断，从而MIPS 将PC 指向0x80000080，从而跳转到.text.exc_vec3代码段执行。对于实时钟引起的中断，通过.text.exc_vec3代码段的分发，最终会调用handle_ int 函数来处理实时钟中断。 在handle_ int 判断CP0_CAUSE寄存器是不是对应的4 号中断位引发的中断，如果是，则执行中断服务函数timer_ irq。 在timer_ irq 里直接跳转到sched_ yield 中执行。而这个函数就是我们将要补充的调度函数。  SAVE_ALL 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64  .macro SAVE_ALL // 前四行其首先取出了 SR 寄存器的值, 然后利用移位等操作判断第 28 位的值, 根据前面的讲述我们可以知道, 也即判断当前是否处于用户模式下。5 mfc0\tk0,CP0_STATUS sll\tk0,3 /* extract cu0 bit */ bltz\tk0,1f nop /* * Called from user mode, new stack */ // lui\tk1,%hi(kernelsp) // lw\tk1,%lo(kernelsp)(k1) //not clear right now // 接下来将当前运行栈的地址保存到 k0 中；然后调用 get_sp 宏，根据中断异常的种类判断需要保存的位置，并分配一定的空间；将之前的运行栈地址与 2 号寄存器 $v0 先保存起来，便于后面可以放心的使用 sp 寄存器与 v0 寄存器。 1: move\tk0,sp get_sp move\tk1,sp subu\tsp,k1,TF_SIZE sw\tk0,TF_REG29(sp) sw\t$2,TF_REG2(sp) mfc0\tv0,CP0_STATUS sw\tv0,TF_STATUS(sp) mfc0\tv0,CP0_CAUSE sw\tv0,TF_CAUSE(sp) mfc0\tv0,CP0_EPC sw\tv0,TF_EPC(sp) mfc0\tv0, CP0_BADVADDR sw\tv0, TF_BADVADDR(sp) mfhi\tv0 sw\tv0,TF_HI(sp) mflo\tv0 sw\tv0,TF_LO(sp) sw\t$0,TF_REG0(sp) sw\t$1,TF_REG1(sp) //sw\t$2,TF_REG2(sp) sw\t$3,TF_REG3(sp) sw\t$4,TF_REG4(sp) sw\t$5,TF_REG5(sp) sw\t$6,TF_REG6(sp) sw\t$7,TF_REG7(sp) sw\t$8,TF_REG8(sp) sw\t$9,TF_REG9(sp) sw\t$10,TF_REG10(sp) sw\t$11,TF_REG11(sp) sw\t$12,TF_REG12(sp) sw\t$13,TF_REG13(sp) sw\t$14,TF_REG14(sp) sw\t$15,TF_REG15(sp) sw\t$16,TF_REG16(sp) sw\t$17,TF_REG17(sp) sw\t$18,TF_REG18(sp) sw\t$19,TF_REG19(sp) sw\t$20,TF_REG20(sp) sw\t$21,TF_REG21(sp) sw\t$22,TF_REG22(sp) sw\t$23,TF_REG23(sp) sw\t$24,TF_REG24(sp) sw\t$25,TF_REG25(sp) sw\t$26,TF_REG26(sp) sw\t$27,TF_REG27(sp) sw\t$28,TF_REG28(sp) sw\t$30,TF_REG30(sp) sw\t$31,TF_REG31(sp) .endm   内存地图 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43  /* o 4G ----------- +----------------------------+------------0x100000000 o | ... | kseg3 o +----------------------------+------------0xe000 0000 o | ... | kseg2 o +----------------------------+------------0xc000 0000 o | Interrupts \u0026 Exception | kseg1 o +----------------------------+------------0xa000 0000 o | Invalid memory | /|\\ o +----------------------------+----|-------Physics Memory Max o | ... | kseg0 o VPT,KSTACKTOP----- +----------------------------+----|-------0x8040 0000-------end o | Kernel Stack | | KSTKSIZE /|\\ o +----------------------------+----|------ | o | Kernel Text | | PDMAP o KERNBASE ----- +----------------------------+----|-------0x8001 0000 | o | Interrupts \u0026 Exception | \\|/ \\|/ o ULIM ----- +----------------------------+------------0x8000 0000------- o | User VPT | PDMAP /|\\ o UVPT ----- +----------------------------+------------0x7fc0 0000 | o | PAGES | PDMAP | o UPAGES ----- +----------------------------+------------0x7f80 0000 | o | ENVS | PDMAP | o UTOP,UENVS ----- +----------------------------+------------0x7f40 0000 | o UXSTACKTOP -/ | user exception stack | BY2PG | o +----------------------------+------------0x7f3f f000 | o | Invalid memory | BY2PG | o USTACKTOP ---- +----------------------------+------------0x7f3f e000 | o | normal user stack | BY2PG | o +----------------------------+------------0x7f3f d000 | a | | | a ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ | a . . | a . . kuseg a . . | a |~~~~~~~~~~~~~~~~~~~~~~~~~~~~| | a | | | o UTEXT ----- +----------------------------+ | o | | 2 * PDMAP \\|/ a 0 ------------ +----------------------------+ ----------------------------- o */    boot_pgdir 被映射到UPAGES envs被映射到UENVS  04000000\n异常与中断 我们实验里认为凡是引起控制流突变的都叫做异常，而中断仅仅是异常的一种，并且是仅有的一种异步异常。\n异常的产生与返回 ","wordCount":"4032","inLanguage":"en","datePublished":"2022-05-08T17:43:03+08:00","dateModified":"2022-05-08T17:43:03+08:00","author":[{"@type":"Person","name":"Appletea"}],"mainEntityOfPage":{"@type":"WebPage","@id":"http://appletea233.github.io/myblog_hogo/posts/blog/%E6%96%87%E6%A1%A3/"},"publisher":{"@type":"Organization","name":"Appletea's Blog","logo":{"@type":"ImageObject","url":"http://appletea233.github.io/myblog_hogo/img/Q.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://appletea233.github.io/myblog_hogo accesskey=h title="Appletea's Blog (Alt + H)">Appletea's Blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=http://appletea233.github.io/myblog_hogo/search title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li><li><a href=http://appletea233.github.io/myblog_hogo/ title=🏠主页><span>🏠主页</span></a></li><li><a href=http://appletea233.github.io/myblog_hogo/posts title=📚文章><span>📚文章</span></a></li><li><a href=http://appletea233.github.io/myblog_hogo/archives/ title=⏱时间轴><span>⏱时间轴</span></a></li><li><a href=http://appletea233.github.io/myblog_hogo/tags title=🔖标签><span>🔖标签</span></a></li><li><a href=http://appletea233.github.io/myblog_hogo/about title=🙋🏻‍♂️关于><span>🙋🏻‍♂️关于</span></a></li><li><a href=http://appletea233.github.io/myblog_hogo/links title=🤝友链><span>🤝友链</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://appletea233.github.io/myblog_hogo>Home</a>&nbsp;»&nbsp;<a href=http://appletea233.github.io/myblog_hogo/posts/>📚文章</a>&nbsp;»&nbsp;<a href=http://appletea233.github.io/myblog_hogo/posts/blog/>Blog</a></div><h1 class=post-title>BUAA操作系统lab3笔记</h1><div class=post-description>如题</div><div class=post-meta>创建:&nbsp;<span title="2022-05-08 17:43:03 +0800 +0800">2022-05-08</span>&nbsp;更新:&nbsp;2022-05-08&nbsp;字数:&nbsp;4032字&nbsp;时长:&nbsp;9分钟&nbsp;<br>作者:&nbsp;Appletea&nbsp;标签:
<a href=http://appletea233.github.io/myblog_hogo/tags/study>study</a>
<a href=http://appletea233.github.io/myblog_hogo/tags/os>os</a>
本文总阅读量:&nbsp<span id=busuanzi_value_page_pv></span>次</p></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><ul><li><a href=#%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%e5%85%b3%e7%b3%bb aria-label=函数调用关系>函数调用关系</a></li><li><a href=#%e7%bb%93%e6%9e%84%e4%bd%93%e4%bf%a1%e6%81%af aria-label=结构体信息>结构体信息</a><ul><li><a href=#page aria-label=Page>Page</a></li><li><a href=#trapframe aria-label=Trapframe>Trapframe</a></li><li><a href=#env aria-label=Env>Env</a></li></ul></li><li><a href=#ehdr%e4%b8%8ephdr aria-label=Ehdr与Phdr>Ehdr与Phdr</a><ul><li><a href=#%e4%b8%80%e4%ba%9b%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8f aria-label=一些全局变量>一些全局变量</a></li></ul></li><li><a href=#%e5%8f%98%e9%87%8f%e8%bd%ac%e6%8d%a2 aria-label=变量转换>变量转换</a></li></ul><li><a href=#exercise aria-label=Exercise>Exercise</a><ul><li><a href=#exercise-31 aria-label="exercise 3.1">exercise 3.1</a></li><li><a href=#exercise-32 aria-label="exercise 3.2">exercise 3.2</a></li><li><a href=#exercise-33 aria-label="exercise 3.3">exercise 3.3</a><ul><li><a href=#%e5%85%b3%e4%ba%8easid_alloc%e5%87%bd%e6%95%b0 aria-label=关于asid_alloc函数>关于<code>asid_alloc</code>函数</a></li></ul></li><li><a href=#exercise-34-env_setup_vm aria-label="exercise 3.4 env_setup_vm">exercise 3.4 <code>env_setup_vm</code></a></li><li><a href=#exercise-35-env_alloc aria-label="exercise 3.5 env_alloc">exercise 3.5 <code>env_alloc</code></a></li><li><a href=#exercise-36-load_icode_mapper aria-label="exercise 3.6 load_icode_mapper	">exercise 3.6 <code>load_icode_mapper</code></a></li><li><a href=#exercise-37-load_elf%e5%92%8cload_icode aria-label="exercise 3.7 load_elf和load_icode">exercise 3.7 <code>load_elf</code>和<code>load_icode</code></a></li><li><a href=#exercise-38-env_create-%e5%92%8cenv_create_priority aria-label="exercise 3.8 env_create 和env_create_priority">exercise 3.8 <code>env_create </code>和<code>env_create_priority</code></a></li><li><a href=#exercise-39-mips_init aria-label="exercise 3.9 mips_init">exercise 3.9 <code>mips_init</code></a></li><li><a href=#exercise-310-env_run aria-label="exercise 3.10 env_run">exercise 3.10 <code>env_run</code></a></li><li><a href=#exercise-311-page_init aria-label="exercise 3.11 page_init">exercise 3.11 <code>page_init</code></a></li></ul></li><li><a href=#thinking aria-label=Thinking>Thinking</a><ul><li><a href=#thinking-31 aria-label="Thinking 3.1">Thinking 3.1</a></li><li><a href=#thinking-32 aria-label="Thinking 3.2">Thinking 3.2</a></li><li><a href=#thinking-33 aria-label="Thinking 3.3">Thinking 3.3</a></li><li><a href=#thinking-34 aria-label="Thinking 3.4">Thinking 3.4</a></li><li><a href=#thinking-35 aria-label="Thinking 3.5">Thinking 3.5</a></li><li><a href=#thinking-36 aria-label="Thinking 3.6">Thinking 3.6</a></li><li><a href=#thinking-37 aria-label="Thinking 3.7">Thinking 3.7</a></li><li><a href=#thinking-38 aria-label="Thinking 3.8">Thinking 3.8</a></li><li><a href=#thinking-39 aria-label="Thinking 3.9">Thinking 3.9</a><ul><li><a href=#set_timer aria-label=set_timer>set_timer</a></li><li><a href=#time_irq aria-label=time_irq>time_irq</a></li><li><a href=#save_all aria-label=SAVE_ALL>SAVE_ALL</a></li></ul></li></ul></li><li><a href=#%e5%86%85%e5%ad%98%e5%9c%b0%e5%9b%be aria-label=内存地图>内存地图</a></li><li><a href=#%e5%bc%82%e5%b8%b8%e4%b8%8e%e4%b8%ad%e6%96%ad aria-label=异常与中断>异常与中断</a><ul><li><a href=#%e5%bc%82%e5%b8%b8%e7%9a%84%e4%ba%a7%e7%94%9f%e4%b8%8e%e8%bf%94%e5%9b%9e aria-label=异常的产生与返回>异常的产生与返回</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const e=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${e}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h3 id=函数调用关系>函数调用关系<a hidden class=anchor aria-hidden=true href=#函数调用关系>#</a></h3><p><img loading=lazy src=../%e6%96%87%e6%a1%a3.assets/image-20220427155529203.png alt=image-20220427155529203></p><h3 id=结构体信息>结构体信息<a hidden class=anchor aria-hidden=true href=#结构体信息>#</a></h3><h4 id=page>Page<a hidden class=anchor aria-hidden=true href=#page>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>Page_list</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>struct</span> <span class=n>Page</span> <span class=o>*</span><span class=n>le_next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>struct</span> <span class=n>Page</span> <span class=n>le_prev</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=n>pp_link</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>u_short</span> <span class=n>pp_ref</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=o>*</span> <span class=n>lh_first</span><span class=p>;</span> <span class=c1>// Page*
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>Env_list</code>结构与之类似</li></ul><h4 id=trapframe>Trapframe<a hidden class=anchor aria-hidden=true href=#trapframe>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>Trapframe</span> <span class=p>{</span> <span class=c1>//lr:need to be modified(reference to linux pt_regs) TODO
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=cm>/* Saved main processor registers. */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>regs</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* Saved special registers. */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>cp0_status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>hi</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>lo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>cp0_badvaddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>cp0_cause</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>cp0_epc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>pc</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=env>Env<a hidden class=anchor aria-hidden=true href=#env>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>Env</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=k>struct</span> <span class=n>Trapframe</span> <span class=n>env_tf</span><span class=p>;</span>       <span class=c1>// Saved registers 
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=n>LIST_ENTRY</span><span class=p>(</span><span class=n>Env</span><span class=p>)</span> <span class=n>env_link</span><span class=p>;</span>      <span class=c1>// Free LIST_ENTRY 
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=n>u_int</span> <span class=n>env_id</span><span class=p>;</span>                  <span class=c1>// Unique environment identifier 
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=n>u_int</span> <span class=n>env_parent_id</span><span class=p>;</span>           <span class=c1>// env_id of this env&#39;s parent 
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=n>u_int</span> <span class=n>env_status</span><span class=p>;</span>              <span class=c1>// Status of the environment 
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=n>Pde</span> <span class=o>*</span><span class=n>env_pgdir</span><span class=p>;</span>                <span class=c1>// Kernel virtual address of page dir 
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=n>u_int</span> <span class=n>env_cr3</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>     <span class=n>LIST_ENTRY</span><span class=p>(</span><span class=n>Env</span><span class=p>)</span> <span class=n>env_sched_link</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>     <span class=n>u_int</span> <span class=n>env_pri</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>env_status : 该变量只能有以下三种取值：</li></ul><ol><li>ENV_FREE : 表明该进程是不活动的，即该进程控制块处于进程空闲链表中。</li><li>ENV_NOT_RUNNABLE : 表明该进程处于阻塞状态，处于该状态的进程需要在一定条件下变成就绪状态从而被CPU调度。（比如因进程通信阻塞时变为 ENV_NOT_RUNNABLE，收到信息后变回 ENV_RUNNABLE）</li><li>ENV_RUNNABLE : 表明该进程处于执行状态或就绪状态，即其可能是正在运行的，也可能正在等待被调度。</li></ol><h3 id=ehdr与phdr>Ehdr与Phdr<a hidden class=anchor aria-hidden=true href=#ehdr与phdr>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>char</span>	<span class=n>e_ident</span><span class=p>[</span><span class=n>EI_NIDENT</span><span class=p>];</span>	<span class=cm>/* Magic number and other info */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Half</span>	<span class=n>e_type</span><span class=p>;</span>			<span class=cm>/* Object file type */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Half</span>	<span class=n>e_machine</span><span class=p>;</span>		<span class=cm>/* Architecture */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Word</span>	<span class=n>e_version</span><span class=p>;</span>		<span class=cm>/* Object file version */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Addr</span>	<span class=n>e_entry</span><span class=p>;</span>		<span class=cm>/* Entry point virtual address */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Off</span>	<span class=n>e_phoff</span><span class=p>;</span>		<span class=cm>/* Program header table file offset */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Off</span>	<span class=n>e_shoff</span><span class=p>;</span>		<span class=cm>/* Section header table file offset */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Word</span>	<span class=n>e_flags</span><span class=p>;</span>		<span class=cm>/* Processor-specific flags */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Half</span>	<span class=n>e_ehsize</span><span class=p>;</span>		<span class=cm>/* ELF header size in bytes */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Half</span>	<span class=n>e_phentsize</span><span class=p>;</span>		<span class=cm>/* Program header table entry size */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Half</span>	<span class=n>e_phnum</span><span class=p>;</span>		<span class=cm>/* Program header table entry count */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Half</span>	<span class=n>e_shentsize</span><span class=p>;</span>		<span class=cm>/* Section header table entry size */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Half</span>	<span class=n>e_shnum</span><span class=p>;</span>		<span class=cm>/* Section header table entry count */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Half</span>	<span class=n>e_shstrndx</span><span class=p>;</span>		<span class=cm>/* Section header string table index */</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>Elf32_Ehdr</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Word</span>	<span class=n>p_type</span><span class=p>;</span>			<span class=cm>/* Segment type */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Off</span>	<span class=n>p_offset</span><span class=p>;</span>		<span class=cm>/* Segment file offset */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Addr</span>	<span class=n>p_vaddr</span><span class=p>;</span>		<span class=cm>/* Segment virtual address */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Addr</span>	<span class=n>p_paddr</span><span class=p>;</span>		<span class=cm>/* Segment physical address */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Word</span>	<span class=n>p_filesz</span><span class=p>;</span>		<span class=cm>/* Segment size in file */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Word</span>	<span class=n>p_memsz</span><span class=p>;</span>		<span class=cm>/* Segment size in memory */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Word</span>	<span class=n>p_flags</span><span class=p>;</span>		<span class=cm>/* Segment flags */</span>
</span></span><span class=line><span class=cl>	<span class=n>Elf32_Word</span>	<span class=n>p_align</span><span class=p>;</span>		<span class=cm>/* Segment alignment */</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>Elf32_Phdr</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=一些全局变量>一些全局变量<a hidden class=anchor aria-hidden=true href=#一些全局变量>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// env.h
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>.</span><span class=o>/</span><span class=n>include</span><span class=o>/</span><span class=n>env</span><span class=p>.</span><span class=nl>h</span><span class=p>:</span><span class=mi>11</span><span class=o>:</span><span class=err>#</span><span class=n>define</span> <span class=n>LOG2NENV</span>     <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=o>/</span><span class=n>include</span><span class=o>/</span><span class=n>env</span><span class=p>.</span><span class=nl>h</span><span class=p>:</span><span class=mi>12</span><span class=o>:</span><span class=err>#</span><span class=n>define</span> <span class=n>NENV</span>         <span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=n>LOG2NENV</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=o>/</span><span class=n>include</span><span class=o>/</span><span class=n>env</span><span class=p>.</span><span class=nl>h</span><span class=p>:</span><span class=mi>13</span><span class=o>:</span><span class=err>#</span><span class=n>define</span> <span class=n>ENVX</span><span class=p>(</span><span class=n>envid</span><span class=p>)</span>  <span class=p>((</span><span class=n>envid</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>NENV</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=c1>// env.c
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=n>Env</span> <span class=o>*</span><span class=n>envs</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>        <span class=c1>// All environments
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=n>Env</span> <span class=o>*</span><span class=n>curenv</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>            <span class=c1>// the current env
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>Env_list</span> <span class=n>env_free_list</span><span class=p>;</span>    <span class=c1>// Free list
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=n>Env_list</span> <span class=n>env_sched_list</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>      <span class=c1>// Runnable list
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=n>Pde</span> <span class=o>*</span><span class=n>boot_pgdir</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=kt>char</span> <span class=o>*</span><span class=n>KERNEL_SP</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>u_int</span> <span class=n>asid_bitmap</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span> <span class=c1>// 64
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// mmu.c
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>.</span><span class=o>/</span><span class=n>include</span><span class=o>/</span><span class=n>error</span><span class=p>.</span><span class=nl>h</span><span class=p>:</span><span class=mi>8</span><span class=o>:</span><span class=err>#</span><span class=n>define</span> <span class=n>E_BAD_ENV</span>       <span class=mi>2</span>       <span class=c1>// Environment doesn&#39;t exist or otherwise
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>.</span><span class=o>/</span><span class=n>include</span><span class=o>/</span><span class=n>mmu</span><span class=p>.</span><span class=nl>h</span><span class=p>:</span><span class=mi>109</span><span class=o>:</span><span class=err>#</span><span class=n>define</span> <span class=n>E_BAD_ENV</span>       <span class=mi>2</span>       <span class=c1>// Environment doesn&#39;t exist or otherwise
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// page相关
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define BY2PG		4096		</span><span class=c1>// bytes to a page
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PDMAP		(4*1024*1024)	</span><span class=c1>// bytes mapped by a page directory entry
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PGSHIFT		12
</span></span></span><span class=line><span class=cl><span class=cp>#define PDSHIFT		22		</span><span class=c1>// log2(PDMAP)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PDX(va)		((((u_long)(va))&gt;&gt;22) &amp; 0x03FF) </span><span class=c1>// 取页目录序号
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PTX(va)		((((u_long)(va))&gt;&gt;12) &amp; 0x03FF) </span><span class=c1>// 取...序号
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PTE_ADDR(pte)	((u_long)(pte)&amp;~0xFFF)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// page number field of address
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PPN(va)		(((u_long)(va))&gt;&gt;12)
</span></span></span><span class=line><span class=cl><span class=cp>#define VPN(va)		PPN(va)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define VA2PFN(va)		(((u_long)(va)) &amp; 0xFFFFF000 ) </span><span class=c1>// va 2 PFN for EntryLo0/1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PTE2PT		1024
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// 内存地图
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define KERNBASE 0x80010000
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define VPT (ULIM + PDMAP )
</span></span></span><span class=line><span class=cl><span class=cp>#define KSTACKTOP (VPT-0x100)
</span></span></span><span class=line><span class=cl><span class=cp>#define KSTKSIZE (8*BY2PG)
</span></span></span><span class=line><span class=cl><span class=cp>#define ULIM 0x80000000	
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define UVPT (ULIM - PDMAP)
</span></span></span><span class=line><span class=cl><span class=cp>#define UPAGES (UVPT - PDMAP)
</span></span></span><span class=line><span class=cl><span class=cp>#define UENVS (UPAGES - PDMAP)
</span></span></span><span class=line><span class=cl><span class=cp>#define UTOP UENVS
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define UXSTACKTOP (UTOP)
</span></span></span><span class=line><span class=cl><span class=cp>#define TIMESTACK 0x82000000
</span></span></span><span class=line><span class=cl><span class=cp></span>    
</span></span><span class=line><span class=cl><span class=cp>#define PTE_ADDR(pte)        ((u_long)(pte)&amp;~0xFFF)
</span></span></span></code></pre></td></tr></table></div></div><p>0x00400000</p><h3 id=变量转换>变量转换<a hidden class=anchor aria-hidden=true href=#变量转换>#</a></h3><ul><li><code>page2ppn</code></li><li><code>page2pa</code></li><li><code>page2kva</code>：将页转换为内核的虚拟地址</li><li><code>va2pa</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>LIST_HEAD</span><span class=p>(</span><span class=n>Page_list</span><span class=p>,</span> <span class=n>Page</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=nf>LIST_ENTRY</span><span class=p>(</span><span class=n>Page</span><span class=p>)</span> <span class=n>Page_LIST_entry_t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>Page</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>Page_LIST_entry_t</span> <span class=n>pp_link</span><span class=p>;</span>	<span class=cm>/* free list link */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Ref is the count of pointers (usually in page table entries)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// to this page.  This only holds for pages allocated using 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// page_alloc.  Pages allocated at boot time using pmap.c&#39;s &#34;alloc&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// do not have valid reference count fields.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=n>u_short</span> <span class=n>pp_ref</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=k>struct</span> <span class=n>Page</span> <span class=o>*</span><span class=n>pages</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=n>u_long</span>
</span></span><span class=line><span class=cl><span class=nf>page2ppn</span><span class=p>(</span><span class=k>struct</span> <span class=n>Page</span> <span class=o>*</span><span class=n>pp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>pp</span> <span class=o>-</span> <span class=n>pages</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=n>u_long</span>
</span></span><span class=line><span class=cl><span class=nf>page2pa</span><span class=p>(</span><span class=k>struct</span> <span class=n>Page</span> <span class=o>*</span><span class=n>pp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>page2ppn</span><span class=p>(</span><span class=n>pp</span><span class=p>)</span><span class=o>&lt;&lt;</span><span class=n>PGSHIFT</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=k>struct</span> <span class=n>Page</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=nf>pa2page</span><span class=p>(</span><span class=n>u_long</span> <span class=n>pa</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>PPN</span><span class=p>(</span><span class=n>pa</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>npage</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>panic</span><span class=p>(</span><span class=s>&#34;pa2page called with invalid pa: %x&#34;</span><span class=p>,</span> <span class=n>pa</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=n>pages</span><span class=p>[</span><span class=n>PPN</span><span class=p>(</span><span class=n>pa</span><span class=p>)];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=n>u_long</span>
</span></span><span class=line><span class=cl><span class=nf>page2kva</span><span class=p>(</span><span class=k>struct</span> <span class=n>Page</span> <span class=o>*</span><span class=n>pp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>KADDR</span><span class=p>(</span><span class=n>page2pa</span><span class=p>(</span><span class=n>pp</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=n>u_long</span>
</span></span><span class=line><span class=cl><span class=nf>va2pa</span><span class=p>(</span><span class=n>Pde</span> <span class=o>*</span><span class=n>pgdir</span><span class=p>,</span> <span class=n>u_long</span> <span class=n>va</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>Pte</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>pgdir</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>pgdir</span><span class=p>[</span><span class=n>PDX</span><span class=p>(</span><span class=n>va</span><span class=p>)];</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=o>*</span><span class=n>pgdir</span><span class=o>&amp;</span><span class=n>PTE_V</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>~</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>p</span> <span class=o>=</span> <span class=p>(</span><span class=n>Pte</span><span class=o>*</span><span class=p>)</span><span class=n>KADDR</span><span class=p>(</span><span class=n>PTE_ADDR</span><span class=p>(</span><span class=o>*</span><span class=n>pgdir</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>PTX</span><span class=p>(</span><span class=n>va</span><span class=p>)]</span><span class=o>&amp;</span><span class=n>PTE_V</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>~</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>PTE_ADDR</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>PTX</span><span class=p>(</span><span class=n>va</span><span class=p>)]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define ULIM 0x80000000
</span></span></span><span class=line><span class=cl><span class=cp>#define PADDR(kva)						\
</span></span></span><span class=line><span class=cl><span class=cp>({								\
</span></span></span><span class=line><span class=cl><span class=cp>	u_long a = (u_long) (kva);				\
</span></span></span><span class=line><span class=cl><span class=cp>	if (a &lt; ULIM)					\
</span></span></span><span class=line><span class=cl><span class=cp>		panic(&#34;PADDR called with invalid kva %08lx&#34;, a);\
</span></span></span><span class=line><span class=cl><span class=cp>	a - ULIM;						\
</span></span></span><span class=line><span class=cl><span class=cp>})
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// translates from physical address to kernel virtual address
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define KADDR(pa)						\
</span></span></span><span class=line><span class=cl><span class=cp>({								\
</span></span></span><span class=line><span class=cl><span class=cp>	u_long ppn = PPN(pa);					\
</span></span></span><span class=line><span class=cl><span class=cp>	if (ppn &gt;= npage)					\
</span></span></span><span class=line><span class=cl><span class=cp>		panic(&#34;KADDR called with invalid pa %08lx&#34;, (u_long)pa);\
</span></span></span><span class=line><span class=cl><span class=cp>	(pa) + ULIM;					\
</span></span></span><span class=line><span class=cl><span class=cp>})
</span></span></span></code></pre></td></tr></table></div></div><h2 id=exercise>Exercise<a hidden class=anchor aria-hidden=true href=#exercise>#</a></h2><h3 id=exercise-31>exercise 3.1<a hidden class=anchor aria-hidden=true href=#exercise-31>#</a></h3><ul><li>使用<code>boot_map_segment</code>进行段映射，envs 数组应该被UENVS 区域映射</li></ul><h3 id=exercise-32>exercise 3.2<a hidden class=anchor aria-hidden=true href=#exercise-32>#</a></h3><ul><li>使用<code>envs</code>函数，注意<code>queue.h</code>函数调用的参数类型。</li><li>插入顺序为倒序</li></ul><h3 id=exercise-33>exercise 3.3<a hidden class=anchor aria-hidden=true href=#exercise-33>#</a></h3><h4 id=关于asid_alloc函数>关于<code>asid_alloc</code>函数<a hidden class=anchor aria-hidden=true href=#关于asid_alloc函数>#</a></h4><p>asid_alloc 函数，这个函数的作用是为新创建的进程分配一个异于当前所有未被释放的进程的 ASID。</p><ul><li><p>这个 ASID是什么？</p></li><li><p>为什么要与其他的进程不同呢？</p></li></ul><p>根据 lab2 的学习我们得知进程是通过页表来访问内存的，而不同的进程的同一个虚拟地址可能会映射到不同的物理地址。</p><p>为了实现这个功能，TLB 中除了存储页表的映射信息之外，还会存储进程的标识编号，作为 Key 的一部分，用于保证查到的页面映射属于当前进程，而这个编号就是ASID。显然，不同进程的虚拟地址是可以对应相同 VPN 的，而如果 ASID 也不具备唯一标识性，就与 TLB Field 的唯一性要求相矛盾了。因此，直到进程被销毁或 TLB 被清空时，才可以把这个 ASID 分配给其他进程。</p><ul><li>为什么不能简单的通过自增来避免冲突呢？</li></ul><p>简单的回答：用来存储ASID的位数有限，自增容易发生溢出</p><p><img loading=lazy src=../%e6%96%87%e6%a1%a3.assets/image-20220427171313108.png alt=image-20220427171313108></p><h3 id=exercise-34-env_setup_vm>exercise 3.4 <code>env_setup_vm</code><a hidden class=anchor aria-hidden=true href=#exercise-34-env_setup_vm>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>env_setup_vm</span><span class=p>(</span><span class=k>struct</span> <span class=n>Env</span> <span class=o>*</span><span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>PDX</span><span class=p>(</span><span class=n>UTOP</span><span class=p>);</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=n>pgdir</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=n>PDX</span><span class=p>(</span><span class=n>UTOP</span><span class=p>);</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>PTE2PT</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>!=</span> <span class=n>PDX</span><span class=p>(</span><span class=n>VPT</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>i</span> <span class=o>!=</span> <span class=n>PDX</span><span class=p>(</span><span class=n>UVPT</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>pgdir</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>boot_pgdir</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>很多疑问</li><li>关于<code>boot_pgdir</code></li></ul><h3 id=exercise-35-env_alloc>exercise 3.5 <code>env_alloc</code><a hidden class=anchor aria-hidden=true href=#exercise-35-env_alloc>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 设置sp寄存器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>e</span><span class=o>-&gt;</span><span class=n>env_tf</span><span class=p>.</span><span class=n>regs</span><span class=p>[</span><span class=mi>29</span><span class=p>]</span> <span class=o>=</span> <span class=n>USTACKTOP</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=exercise-36-load_icode_mapper>exercise 3.6 <code>load_icode_mapper </code><a hidden class=anchor aria-hidden=true href=#exercise-36-load_icode_mapper>#</a></h3><p>调用链：<code>load_icode -> load_elf -> load_icode_mapper</code></p><h3 id=exercise-37-load_elf和load_icode>exercise 3.7 <code>load_elf</code>和<code>load_icode</code><a hidden class=anchor aria-hidden=true href=#exercise-37-load_elf和load_icode>#</a></h3><h3 id=exercise-38-env_create-和env_create_priority>exercise 3.8 <code>env_create </code>和<code>env_create_priority</code><a hidden class=anchor aria-hidden=true href=#exercise-38-env_create-和env_create_priority>#</a></h3><p>调用链：<code>env_create -> env_create_priority</code></p><h3 id=exercise-39-mips_init>exercise 3.9 <code>mips_init</code><a hidden class=anchor aria-hidden=true href=#exercise-39-mips_init>#</a></h3><h3 id=exercise-310-env_run>exercise 3.10 <code>env_run</code><a hidden class=anchor aria-hidden=true href=#exercise-310-env_run>#</a></h3><h3 id=exercise-311-page_init>exercise 3.11 <code>page_init</code><a hidden class=anchor aria-hidden=true href=#exercise-311-page_init>#</a></h3><h2 id=thinking>Thinking<a hidden class=anchor aria-hidden=true href=#thinking>#</a></h2><h3 id=thinking-31>Thinking 3.1<a hidden class=anchor aria-hidden=true href=#thinking-31>#</a></h3><p>思考envid2env 函数:</p><p>为什么envid2env 中需要判断e->env_id != envid 的情况？如果没有这步判断会发生什么情况？</p><ul><li>envid可能大于64</li><li>没有这一步可能导致非内存控制快的内存地址被转换</li></ul><h3 id=thinking-32>Thinking 3.2<a hidden class=anchor aria-hidden=true href=#thinking-32>#</a></h3><p>结合include/mmu.h 中的地址空间布局，思考env_setup_vm 函数：</p><ul><li>UTOP 和ULIM 的含义分别是什么，UTOP 和ULIM 之间的区域与UTOP以下的区域相比有什么区别？</li></ul><ol><li>ULIM以上是内核态</li><li>UTOP与ULIM之间有三个页表</li><li>ULIM之下的是栈，UTOP和ULIM之间的区域是页表</li></ol><ul><li>请结合系统自映射机制解释代码中pgdir[PDX(UVPT)]=env_cr3的含义。</li></ul><p>自身映射到自身</p><ul><li>谈谈自己对进程中物理地址和虚拟地址的理解。</li></ul><p>之间有映射关系。</p><h3 id=thinking-33>Thinking 3.3<a hidden class=anchor aria-hidden=true href=#thinking-33>#</a></h3><p>找到 user_data 这一参数的来源，思考它的作用。没有这个参数可不可以？为什么？（可以尝试说明实际的应用场景，举一个实际的库中的例子）</p><ul><li>为load_icode_mapper传参</li></ul><h3 id=thinking-34>Thinking 3.4<a hidden class=anchor aria-hidden=true href=#thinking-34>#</a></h3><p>结合load_icode_mapper 的参数以及二进制镜像的大小，考虑该函数可能会面临哪几种复制的情况？你是否都考虑到了？</p><ul><li>va不与页对其</li><li>va+binsize不与页面对齐</li></ul><h3 id=thinking-35>Thinking 3.5<a hidden class=anchor aria-hidden=true href=#thinking-35>#</a></h3><p>思考上面这一段话，并根据自己在lab2 中的理解，回答：</p><ul><li>你认为这里的 env_tf.pc 存储的是物理地址还是虚拟地址?</li></ul><p>是虚拟地址</p><ul><li>你觉得entry_point其值对于每个进程是否一样？该如何理解这种统一或不同</li></ul><p>不一定相同，对不同的elf文件entry_point不同。</p><h3 id=thinking-36>Thinking 3.6<a hidden class=anchor aria-hidden=true href=#thinking-36>#</a></h3><p>请查阅相关资料解释，上面提到的epc是什么？为什么要将env_tf.pc设置为epc呢？</p><h3 id=thinking-37>Thinking 3.7<a hidden class=anchor aria-hidden=true href=#thinking-37>#</a></h3><p>关于 TIMESTACK，请思考以下问题：</p><ul><li>操作系统在何时将什么内容存到了 TIMESTACK 区域</li><li>TIMESTACK 和 env_asm.S 中所定义的 KERNEL_SP 的含义有何不同</li></ul><h3 id=thinking-38>Thinking 3.8<a hidden class=anchor aria-hidden=true href=#thinking-38>#</a></h3><p>试找出上述 5 个异常处理函数的具体实现位置。</p><table><thead><tr><th>异常号</th><th>处理函数</th><th>含义</th><th>具体实现位置</th><th>备注</th></tr></thead><tbody><tr><td>0</td><td>handle_int</td><td>表示中断，由时钟中断、控制台中断等中断造成</td><td>./lib/genex.S</td><td></td></tr><tr><td>1</td><td>handle_mod</td><td>表示存储异常，进行存储操作时该页被标记为只读</td><td>./lib/genex.S</td><td></td></tr><tr><td>2</td><td>handle_tlb</td><td>TLB 异常，TLB 中没有和程序地址匹配的有效入口</td><td>./lib/genex.S</td><td></td></tr><tr><td>3</td><td>handle_tlb</td><td>TLB 异常，TLB 失效，且未处于异常模式（用于提高处理效率）</td><td>./lib/genex.S</td><td></td></tr><tr><td>8</td><td>handle_sys</td><td>系统调用，陷入内核，执行了 syscall 指令</td><td>./lib/syscall.S</td><td></td></tr></tbody></table><h3 id=thinking-39>Thinking 3.9<a hidden class=anchor aria-hidden=true href=#thinking-39>#</a></h3><p>阅读 kclock_asm.S 和 genex.S 两个文件，并尝试说出 set_timer 和timer_irq 函数中每行汇编代码的作用</p><h4 id=set_timer>set_timer<a hidden class=anchor aria-hidden=true href=#set_timer>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>LEAF(set_timer)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	li t0, 0xc8
</span></span><span class=line><span class=cl>	sb t0, 0xb5000100	// 向0xb5000100 位置写入0xc8
</span></span><span class=line><span class=cl>	sw	sp, KERNEL_SP	// 将当前栈指针保存到KERNEL_SP
</span></span><span class=line><span class=cl>	setup_c0_status STATUS_CU0|0x1001 0	// 调用setup_c0_status函数
</span></span><span class=line><span class=cl>	jr ra
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	nop
</span></span><span class=line><span class=cl>END(set_timer)
</span></span></code></pre></td></tr></table></div></div><h4 id=time_irq>time_irq<a hidden class=anchor aria-hidden=true href=#time_irq>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>timer_irq:
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	sb zero, 0xb5000110	// 在0xb5000110写入0
</span></span><span class=line><span class=cl>1:	j	sched_yield		// 跳转到sched_ yield 
</span></span><span class=line><span class=cl>	nop
</span></span><span class=line><span class=cl>	/*li t1, 0xff
</span></span><span class=line><span class=cl>	lw    t0, delay
</span></span><span class=line><span class=cl>	addu  t0, 1
</span></span><span class=line><span class=cl>	sw	t0, delay
</span></span><span class=line><span class=cl>	beq	t0,t1,1f	
</span></span><span class=line><span class=cl>	nop*/
</span></span><span class=line><span class=cl>	j	ret_from_exception	
</span></span><span class=line><span class=cl>	nop
</span></span></code></pre></td></tr></table></div></div><p>要产生时钟中断，我们不仅要了解中断的产生与处理，还要了解 gxemul 是如何模拟时钟中断的。kclock_init 函数完成了时钟的初始化，该函数主要调用 set_timer 函数，完成如下操作：</p><ul><li>首先向0xb5000100 位置写入0xc8，其中0xb5000000 是模拟器(gxemul) 映射实时钟的位置。偏移量为0x100 表示来设置实时钟中断的频率，0xc8 则表示1 秒钟中断200次，如果写入0，表示关闭实时钟。实时钟对于R3000 来说绑定到了4 号中断上，故这段代码其实主要用来触发了4 号中断。注意这里的中断号和异常号是不一样的概念，我们实验的异常包括中断。</li><li>一旦实时钟中断产生，就会触发MIPS 中断，从而MIPS 将PC 指向0x80000080，从而跳转到.text.exc_vec3代码段执行。对于实时钟引起的中断，通过.text.exc_vec3代码段的分发，最终会调用handle_ int 函数来处理实时钟中断。</li><li>在handle_ int 判断CP0_CAUSE寄存器是不是对应的4 号中断位引发的中断，如果是，则执行中断服务函数timer_ irq。</li><li>在timer_ irq 里直接跳转到sched_ yield 中执行。而这个函数就是我们将要补充的调度函数。</li></ul><h4 id=save_all>SAVE_ALL<a hidden class=anchor aria-hidden=true href=#save_all>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>.macro SAVE_ALL
</span></span><span class=line><span class=cl>		// 前四行其首先取出了 SR 寄存器的值, 然后利用移位等操作判断第 28 位的值, 根据前面的讲述我们可以知道, 也即判断当前是否处于用户模式下。5
</span></span><span class=line><span class=cl>		mfc0	k0,CP0_STATUS
</span></span><span class=line><span class=cl>		sll		k0,3      /* extract cu0 bit */
</span></span><span class=line><span class=cl>		bltz	k0,1f
</span></span><span class=line><span class=cl>		nop
</span></span><span class=line><span class=cl>		/*
</span></span><span class=line><span class=cl>		 * Called from user mode, new stack
</span></span><span class=line><span class=cl>		 */
</span></span><span class=line><span class=cl>		// lui	k1,%hi(kernelsp)
</span></span><span class=line><span class=cl>		// lw	k1,%lo(kernelsp)(k1)  //not clear right now
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		// 接下来将当前运行栈的地址保存到 k0 中；然后调用 get_sp 宏，根据中断异常的种类判断需要保存的位置，并分配一定的空间；将之前的运行栈地址与 2 号寄存器 $v0 先保存起来，便于后面可以放心的使用 sp 寄存器与 v0 寄存器。
</span></span><span class=line><span class=cl>1:
</span></span><span class=line><span class=cl>		move	k0,sp
</span></span><span class=line><span class=cl>		get_sp
</span></span><span class=line><span class=cl>		move	k1,sp
</span></span><span class=line><span class=cl>		subu	sp,k1,TF_SIZE
</span></span><span class=line><span class=cl>		sw	k0,TF_REG29(sp)
</span></span><span class=line><span class=cl>		sw	$2,TF_REG2(sp)
</span></span><span class=line><span class=cl>		mfc0	v0,CP0_STATUS
</span></span><span class=line><span class=cl>		sw	v0,TF_STATUS(sp)
</span></span><span class=line><span class=cl>		mfc0	v0,CP0_CAUSE
</span></span><span class=line><span class=cl>		sw	v0,TF_CAUSE(sp)
</span></span><span class=line><span class=cl>		mfc0	v0,CP0_EPC
</span></span><span class=line><span class=cl>		sw	v0,TF_EPC(sp)
</span></span><span class=line><span class=cl>		mfc0	v0, CP0_BADVADDR
</span></span><span class=line><span class=cl>		sw	v0, TF_BADVADDR(sp)
</span></span><span class=line><span class=cl>		mfhi	v0
</span></span><span class=line><span class=cl>		sw	v0,TF_HI(sp)
</span></span><span class=line><span class=cl>		mflo	v0
</span></span><span class=line><span class=cl>		sw	v0,TF_LO(sp)
</span></span><span class=line><span class=cl>		sw	$0,TF_REG0(sp)
</span></span><span class=line><span class=cl>		sw	$1,TF_REG1(sp)
</span></span><span class=line><span class=cl>		//sw	$2,TF_REG2(sp)
</span></span><span class=line><span class=cl>		sw	$3,TF_REG3(sp)
</span></span><span class=line><span class=cl>		sw	$4,TF_REG4(sp)
</span></span><span class=line><span class=cl>		sw	$5,TF_REG5(sp)
</span></span><span class=line><span class=cl>		sw	$6,TF_REG6(sp)
</span></span><span class=line><span class=cl>		sw	$7,TF_REG7(sp)
</span></span><span class=line><span class=cl>		sw	$8,TF_REG8(sp)
</span></span><span class=line><span class=cl>		sw	$9,TF_REG9(sp)
</span></span><span class=line><span class=cl>		sw	$10,TF_REG10(sp)
</span></span><span class=line><span class=cl>		sw	$11,TF_REG11(sp)
</span></span><span class=line><span class=cl>		sw	$12,TF_REG12(sp)
</span></span><span class=line><span class=cl>		sw	$13,TF_REG13(sp)
</span></span><span class=line><span class=cl>		sw	$14,TF_REG14(sp)
</span></span><span class=line><span class=cl>		sw	$15,TF_REG15(sp)
</span></span><span class=line><span class=cl>		sw	$16,TF_REG16(sp)
</span></span><span class=line><span class=cl>		sw	$17,TF_REG17(sp)
</span></span><span class=line><span class=cl>		sw	$18,TF_REG18(sp)
</span></span><span class=line><span class=cl>		sw	$19,TF_REG19(sp)
</span></span><span class=line><span class=cl>		sw	$20,TF_REG20(sp)
</span></span><span class=line><span class=cl>		sw	$21,TF_REG21(sp)
</span></span><span class=line><span class=cl>		sw	$22,TF_REG22(sp)
</span></span><span class=line><span class=cl>		sw	$23,TF_REG23(sp)
</span></span><span class=line><span class=cl>		sw	$24,TF_REG24(sp)
</span></span><span class=line><span class=cl>		sw	$25,TF_REG25(sp)
</span></span><span class=line><span class=cl>		sw	$26,TF_REG26(sp) 
</span></span><span class=line><span class=cl>		sw	$27,TF_REG27(sp) 
</span></span><span class=line><span class=cl>		sw	$28,TF_REG28(sp)
</span></span><span class=line><span class=cl>		sw	$30,TF_REG30(sp)
</span></span><span class=line><span class=cl>		sw	$31,TF_REG31(sp)
</span></span><span class=line><span class=cl>.endm
</span></span></code></pre></td></tr></table></div></div><h2 id=内存地图>内存地图<a hidden class=anchor aria-hidden=true href=#内存地图>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> o     4G -----------&gt;  +----------------------------+------------0x100000000
</span></span></span><span class=line><span class=cl><span class=cm> o                      |       ...                  |  kseg3
</span></span></span><span class=line><span class=cl><span class=cm> o                      +----------------------------+------------0xe000 0000
</span></span></span><span class=line><span class=cl><span class=cm> o                      |       ...                  |  kseg2
</span></span></span><span class=line><span class=cl><span class=cm> o                      +----------------------------+------------0xc000 0000
</span></span></span><span class=line><span class=cl><span class=cm> o                      |   Interrupts &amp; Exception   |  kseg1
</span></span></span><span class=line><span class=cl><span class=cm> o                      +----------------------------+------------0xa000 0000
</span></span></span><span class=line><span class=cl><span class=cm> o                      |      Invalid memory        |   /|\
</span></span></span><span class=line><span class=cl><span class=cm> o                      +----------------------------+----|-------Physics Memory Max
</span></span></span><span class=line><span class=cl><span class=cm> o                      |       ...                  |  kseg0
</span></span></span><span class=line><span class=cl><span class=cm> o  VPT,KSTACKTOP-----&gt; +----------------------------+----|-------0x8040 0000-------end
</span></span></span><span class=line><span class=cl><span class=cm> o                      |       Kernel Stack         |    | KSTKSIZE            /|\
</span></span></span><span class=line><span class=cl><span class=cm> o                      +----------------------------+----|------                |
</span></span></span><span class=line><span class=cl><span class=cm> o                      |       Kernel Text          |    |                    PDMAP
</span></span></span><span class=line><span class=cl><span class=cm> o      KERNBASE -----&gt; +----------------------------+----|-------0x8001 0000    | 
</span></span></span><span class=line><span class=cl><span class=cm> o                      |   Interrupts &amp; Exception   |   \|/                    \|/
</span></span></span><span class=line><span class=cl><span class=cm> o      ULIM     -----&gt; +----------------------------+------------0x8000 0000-------    
</span></span></span><span class=line><span class=cl><span class=cm> o                      |         User VPT           |     PDMAP                /|\ 
</span></span></span><span class=line><span class=cl><span class=cm> o      UVPT     -----&gt; +----------------------------+------------0x7fc0 0000    |
</span></span></span><span class=line><span class=cl><span class=cm> o                      |         PAGES              |     PDMAP                 |
</span></span></span><span class=line><span class=cl><span class=cm> o      UPAGES   -----&gt; +----------------------------+------------0x7f80 0000    |
</span></span></span><span class=line><span class=cl><span class=cm> o                      |         ENVS               |     PDMAP                 |
</span></span></span><span class=line><span class=cl><span class=cm> o  UTOP,UENVS   -----&gt; +----------------------------+------------0x7f40 0000    |
</span></span></span><span class=line><span class=cl><span class=cm> o  UXSTACKTOP -/       |     user exception stack   |     BY2PG               	   |
</span></span></span><span class=line><span class=cl><span class=cm> o                      +----------------------------+------------0x7f3f f000    |
</span></span></span><span class=line><span class=cl><span class=cm> o                      |       Invalid memory       |     BY2PG                 |
</span></span></span><span class=line><span class=cl><span class=cm> o      USTACKTOP ----&gt; +----------------------------+------------0x7f3f e000    |
</span></span></span><span class=line><span class=cl><span class=cm> o                      |     normal user stack      |     BY2PG                 |
</span></span></span><span class=line><span class=cl><span class=cm> o                      +----------------------------+------------0x7f3f d000    |
</span></span></span><span class=line><span class=cl><span class=cm> a                      |                            |                           |
</span></span></span><span class=line><span class=cl><span class=cm> a                      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                           |
</span></span></span><span class=line><span class=cl><span class=cm> a                      .                            .                           |
</span></span></span><span class=line><span class=cl><span class=cm> a                      .                            .                         kuseg
</span></span></span><span class=line><span class=cl><span class=cm> a                      .                            .                           |
</span></span></span><span class=line><span class=cl><span class=cm> a                      |~~~~~~~~~~~~~~~~~~~~~~~~~~~~|                           |
</span></span></span><span class=line><span class=cl><span class=cm> a                      |                            |                           |
</span></span></span><span class=line><span class=cl><span class=cm> o       UTEXT   -----&gt; +----------------------------+                           |
</span></span></span><span class=line><span class=cl><span class=cm> o                      |                            |     2 * PDMAP            \|/
</span></span></span><span class=line><span class=cl><span class=cm> a     0 ------------&gt;  +----------------------------+ -----------------------------
</span></span></span><span class=line><span class=cl><span class=cm> o
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>boot_pgdir 被映射到<code>UPAGES</code></li><li>envs被映射到<code>UENVS</code></li></ul><p>04000000</p><h2 id=异常与中断>异常与中断<a hidden class=anchor aria-hidden=true href=#异常与中断>#</a></h2><p>我们实验里认为凡是引起控制流突变的都叫做异常，而中断仅仅是异常的一种，并且是仅有的一种异步异常。</p><h3 id=异常的产生与返回>异常的产生与返回<a hidden class=anchor aria-hidden=true href=#异常的产生与返回>#</a></h3><p><img loading=lazy src=https://os.buaa.edu.cn/assets/courseware/v1/bf6ba882116327e880dbcd654e1a779a/asset-v1:BUAA+B3I062270+2022_SPRING+type@asset+block/3-exception.png alt=异常处理图示></p></div><footer class=post-footer><ul class=post-tags><li><a href=http://appletea233.github.io/myblog_hogo/tags/study/>study</a></li><li><a href=http://appletea233.github.io/myblog_hogo/tags/os/>os</a></li></ul><nav class=paginav><a class=next href=http://appletea233.github.io/myblog_hogo/posts/blog/my-first-post/><span class=title>Next Page »</span><br><span>My First Post</span></a></nav></footer><div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>💬评论</span><hr></div><div id=tcomment></div><script src=https://cdn.jsdelivr.net/npm/twikoo@1.5.9/dist/twikoo.all.min.js></script>
<script>twikoo.init({envId:"https://twikoo-12c9q2x4o-1530457905-qqcom.vercel.app/",el:"#tcomment",lang:"zh-CN",path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><span>&copy; 2022 <a href=http://appletea233.github.io/myblog_hogo>Appletea's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>